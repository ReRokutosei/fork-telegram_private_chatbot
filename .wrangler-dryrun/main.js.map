{
  "version": 3,
  "sources": ["../src/do/rate-limit-do.js", "../src/config/constants.js", "../src/core/logger.js", "../src/core/random.js", "../src/adapters/telegram.js", "../src/services/rate-limit.js", "../src/adapters/storage-d1.js", "../src/services/keywords.js", "../src/services/admin.js", "../src/services/topic-utils.js", "../src/services/verification.js", "../src/services/media-group.js", "../src/services/cleanup.js", "../src/services/topic-lifecycle.js", "../src/services/edit-sync.js", "../src/services/admin-reply.js", "../src/services/message-flow.js", "../src/adapters/storage-kv.js", "../src/handlers/webhook.js", "../src/app.js", "../main.js"],
  "sourceRoot": ".wrangler-dryrun",
  "sourcesContent": ["/**\r\n * Durable Object: \u901F\u7387\u9650\u5236\u670D\u52A1\r\n *\r\n * \u8BBE\u8BA1\u76EE\u6807\uFF1A\r\n * 1. \u901A\u8FC7 Durable Object \u7684\u5355\u7EBF\u7A0B\u6267\u884C\u6A21\u578B\uFF0C\u63D0\u4F9B\u8BA1\u6570\u66F4\u65B0\u7684\u539F\u5B50\u6027\u8BED\u4E49\u3002\r\n * 2. \u4F7F\u7528 SQLite \u6301\u4E45\u5316\u4FDD\u5B58\u9650\u6D41\u72B6\u6001\uFF0C\u964D\u4F4E\u5B9E\u4F8B\u88AB\u9A71\u9010\uFF08eviction\uFF09\u540E\u72B6\u6001\u4E22\u5931\u7684\u98CE\u9669\u3002\r\n * 3. \u652F\u6301\u6309 key \u7EF4\u5EA6\u7684\u72EC\u7ACB\u9650\u6D41\u7B56\u7565\uFF08limit / window \u7531\u8C03\u7528\u65B9\u4F20\u5165\uFF09\u3002\r\n * 4. \u901A\u8FC7\u201C\u5185\u5B58\u7F13\u5B58 + SQLite\u201D\u7EC4\u5408\uFF0C\u517C\u987E\u8BFB\u5199\u6027\u80FD\u4E0E\u6570\u636E\u53EF\u9760\u6027\u3002\r\n *\r\n * \u5BF9\u5916 RPC \u65B9\u6CD5\uFF1A\r\n * - check(key, limit, window) -> { allowed: boolean, remaining: number }\r\n *   - key\uFF1A\u9650\u6D41\u952E\uFF0C\u5EFA\u8BAE\u683C\u5F0F\u4E3A `${action}:${userId}`\uFF0C\u9700\u4FDD\u8BC1\u4E1A\u52A1\u4FA7\u552F\u4E00\u6027\u3002\r\n *   - limit\uFF1A\u7A97\u53E3\u671F\u5185\u5141\u8BB8\u7684\u6700\u5927\u8BF7\u6C42\u6B21\u6570\uFF08\u6B63\u6574\u6570\uFF09\u3002\r\n *   - window\uFF1A\u7A97\u53E3\u671F\u957F\u5EA6\uFF08\u79D2\uFF0C\u6B63\u6570\uFF09\u3002\r\n *\r\n * SQLite \u8868\u7ED3\u6784\uFF1A\r\n * - rate_limits\uFF1A\u6309 key \u8BB0\u5F55\u7A97\u53E3\u671F\u5185\u7684\u8BA1\u6570\u53CA\u8FC7\u671F\u65F6\u95F4\uFF08\u6BEB\u79D2\u65F6\u95F4\u6233\uFF09\u3002\r\n *   - key\uFF1A\u4E3B\u952E\u3002\r\n *   - count\uFF1A\u5F53\u524D\u7A97\u53E3\u671F\u7D2F\u8BA1\u6B21\u6570\u3002\r\n *   - expires_at\uFF1A\u7A97\u53E3\u671F\u7ED3\u675F\u65F6\u95F4\uFF08Unix \u65F6\u95F4\u6233\uFF0C\u6BEB\u79D2\uFF09\u3002\r\n *   - created_at / updated_at\uFF1A\u8BB0\u5F55\u521B\u5EFA\u4E0E\u6700\u540E\u66F4\u65B0\u65F6\u95F4\uFF08Unix \u65F6\u95F4\u6233\uFF0C\u6BEB\u79D2\uFF09\u3002\r\n */\r\n\r\nimport { DurableObject } from 'cloudflare:workers';\r\n\r\nexport class RateLimitDO extends DurableObject {\r\n    constructor(ctx, env) {\r\n        super(ctx, env);\r\n\r\n        /**\r\n         * \u521D\u59CB\u5316 SQLite \u8868\u7ED3\u6784\u3002\r\n         *\r\n         * \u7EA6\u675F\u8BF4\u660E\uFF1A\r\n         * - blockConcurrencyWhile \u7528\u4E8E\u5728\u5B9E\u4F8B\u5BF9\u5916\u63D0\u4F9B\u670D\u52A1\u524D\u5B8C\u6210\u4E00\u6B21\u6027\u521D\u59CB\u5316\uFF0C\u907F\u514D\u5E76\u53D1\u8BF7\u6C42\r\n         *   \u5728\u8868\u5C1A\u672A\u521B\u5EFA\u65F6\u8BBF\u95EE\u5BFC\u81F4\u7684\u9519\u8BEF\u3002\r\n         */\r\n        ctx.blockConcurrencyWhile(async () => {\r\n            this.ctx.storage.sql.exec(`\r\n                CREATE TABLE IF NOT EXISTS rate_limits (\r\n                    key TEXT PRIMARY KEY,\r\n                    count INTEGER NOT NULL DEFAULT 0,\r\n                    expires_at INTEGER NOT NULL,\r\n                    created_at INTEGER NOT NULL,\r\n                    updated_at INTEGER NOT NULL\r\n                );\r\n\r\n                /* expires_at \u7D22\u5F15\u7528\u4E8E\u52A0\u901F\u6309\u8FC7\u671F\u65F6\u95F4\u7684\u6E05\u7406\u4E0E\u7EDF\u8BA1\u67E5\u8BE2 */\r\n                CREATE INDEX IF NOT EXISTS idx_expires_at\r\n                ON rate_limits(expires_at);\r\n            `);\r\n        });\r\n\r\n        /**\r\n         * \u5185\u5B58\u7F13\u5B58\uFF08\u70ED\u70B9 key \u4F18\u5316\uFF09\u3002\r\n         *\r\n         * \u8BF4\u660E\uFF1A\r\n         * - \u4EC5\u4F5C\u4E3A\u6027\u80FD\u4F18\u5316\u7684\u8FD1\u7AEF\u7F13\u5B58\uFF0C\u6570\u636E\u4EE5 SQLite \u4E3A\u6700\u7EC8\u4E8B\u5B9E\u6765\u6E90\uFF08source of truth\uFF09\u3002\r\n         * - \u7F13\u5B58\u9879\u5728 expiresAt \u8FC7\u671F\u540E\u5E94\u89C6\u4E3A\u65E0\u6548\uFF0C\u9700\u56DE\u6E90 SQLite \u51B7\u8BFB\u3002\r\n         *\r\n         * \u7F13\u5B58\u7ED3\u6784\uFF1A\r\n         * - Map<key, { count: number, expiresAt: number }>\r\n         */\r\n        this.cache = new Map();\r\n    }\r\n\r\n    /**\r\n     * RPC\uFF1A\u68C0\u67E5\u5E76\u66F4\u65B0\u9650\u6D41\u8BA1\u6570\u3002\r\n     *\r\n     * \u884C\u4E3A\u5B9A\u4E49\uFF1A\r\n     * - \u82E5\u5F53\u524D\u7A97\u53E3\u671F\u5185\u8BA1\u6570\u672A\u8FBE limit\uFF0C\u5219\u5141\u8BB8\u8BF7\u6C42\u5E76\u5C06\u8BA1\u6570 +1\u3002\r\n     * - \u82E5\u8BA1\u6570\u5DF2\u8FBE limit\uFF0C\u5219\u62D2\u7EDD\u8BF7\u6C42\uFF0C\u4E0D\u518D\u9012\u589E\u8BA1\u6570\u3002\r\n     * - \u82E5\u8BB0\u5F55\u4E0D\u5B58\u5728\u6216\u5DF2\u8FC7\u671F\uFF0C\u5219\u521B\u5EFA/\u91CD\u7F6E\u7A97\u53E3\u671F\u5E76\u5C06\u8BA1\u6570\u7F6E\u4E3A 1\u3002\r\n     *\r\n     * \u6CE8\u610F\uFF1A\r\n     * - \u672C\u5B9E\u73B0\u4F9D\u8D56 Durable Object \u7684\u4E32\u884C\u6267\u884C\u6A21\u578B\u6765\u907F\u514D\u540C\u4E00\u5BF9\u8C61\u5B9E\u4F8B\u5185\u7684\u5E76\u53D1\u7ADE\u6001\u3002\r\n     * - SQLite \u5199\u5165\u901A\u8FC7 exec \u63D0\u4EA4\uFF0C\u5199\u64CD\u4F5C\u5728 DO \u5B58\u50A8\u5C42\u6392\u961F\u6267\u884C\u3002\r\n     */\r\n    async check(key, limit, window) {\r\n        /**\r\n         * \u53C2\u6570\u6821\u9A8C\uFF1A\r\n         * - key\uFF1A\u4E0D\u80FD\u4E3A\u7A7A\u3002\r\n         * - limit/window\uFF1A\u9700\u4E3A\u53EF\u7528\u503C\uFF1B\u6B64\u5904\u6CBF\u7528\u539F\u6709\u6821\u9A8C\u7B56\u7565\uFF08\u4EC5\u5224\u7A7A/\u5224 0\uFF09\uFF0C\u4E0D\u6539\u53D8\u884C\u4E3A\u3002\r\n         */\r\n        if (!key || !limit || !window) {\r\n            throw new Error('Missing parameters: key, limit, window');\r\n        }\r\n\r\n        const now = Date.now();\r\n        const expiresAt = now + (window * 1000);\r\n\r\n        /**\r\n         * \u5FEB\u8DEF\u5F84\uFF1A\u547D\u4E2D\u5185\u5B58\u7F13\u5B58\u4E14\u672A\u8FC7\u671F\u3002\r\n         *\r\n         * \u8BF4\u660E\uFF1A\r\n         * - \u547D\u4E2D\u7F13\u5B58\u53EF\u51CF\u5C11\u4E00\u6B21 SQLite \u8BFB\u53D6\u3002\r\n         * - \u5199\u5165\u4ECD\u9700\u843D\u5E93\uFF0C\u4EE5\u4FDD\u8BC1 DO \u88AB\u9A71\u9010\u540E\u72B6\u6001\u53EF\u6062\u590D\u3002\r\n         */\r\n        const cached = this.cache.get(key);\r\n        if (cached && cached.expiresAt > now) {\r\n            // \u7A97\u53E3\u671F\u5185\u5DF2\u8FBE\u4E0A\u9650\uFF1A\u76F4\u63A5\u62D2\u7EDD\r\n            if (cached.count >= limit) {\r\n                return { allowed: false, remaining: 0 };\r\n            }\r\n\r\n            /**\r\n             * \u9012\u589E\u8BA1\u6570\u5E76\u6301\u4E45\u5316\u3002\r\n             *\r\n             * \u8BF4\u660E\uFF1A\r\n             * - \u4F7F\u7528 UPSERT \u7EDF\u4E00\u5904\u7406\u201C\u63D2\u5165\u6216\u66F4\u65B0\u201D\u8DEF\u5F84\u3002\r\n             * - \u8BE5\u8BED\u53E5\u5728\u51B2\u7A81\u66F4\u65B0\u65F6\u5C06 count \u9012\u589E\uFF0C\u5E76\u66F4\u65B0\u65F6\u95F4\u6233\u5B57\u6BB5\u3002\r\n             */\r\n            this.ctx.storage.sql.exec(\r\n                `INSERT INTO rate_limits (key, count, expires_at, created_at, updated_at)\r\n                 VALUES (?, ?, ?, ?, ?)\r\n                 ON CONFLICT(key) DO UPDATE SET\r\n                 count = count + 1,\r\n                 updated_at = ?`,\r\n                key, cached.count + 1, expiresAt, now, now, now\r\n            );\r\n\r\n            // \u66F4\u65B0\u7F13\u5B58\u4E2D\u7684\u8BA1\u6570\u4E0E\u8FC7\u671F\u65F6\u95F4\r\n            cached.count++;\r\n            this.cache.set(key, { count: cached.count, expiresAt });\r\n\r\n            return { allowed: true, remaining: limit - cached.count };\r\n        }\r\n\r\n        /**\r\n         * \u51B7\u8DEF\u5F84\uFF1A\u56DE\u6E90 SQLite \u67E5\u8BE2\u5F53\u524D\u8BA1\u6570\u4E0E\u8FC7\u671F\u65F6\u95F4\u3002\r\n         */\r\n        const result = this.ctx.storage.sql.exec(\r\n            `SELECT count, expires_at FROM rate_limits WHERE key = ?`,\r\n            key\r\n        ).one();\r\n\r\n        if (result && result.expires_at > now) {\r\n            // \u8BB0\u5F55\u5B58\u5728\u4E14\u4ECD\u5728\u7A97\u53E3\u671F\u5185\r\n            if (result.count >= limit) {\r\n                /**\r\n                 * \u8D85\u9650\u7ED3\u679C\u5199\u5165\u7F13\u5B58\uFF1A\r\n                 * - \u4FBF\u4E8E\u540E\u7EED\u540C\u7A97\u53E3\u671F\u5185\u7684\u8BF7\u6C42\u76F4\u63A5\u547D\u4E2D\u5FEB\u8DEF\u5F84\u62D2\u7EDD\uFF0C\u51CF\u5C11\u6570\u636E\u5E93\u8BFB\u53D6\u3002\r\n                 */\r\n                this.cache.set(key, {\r\n                    count: result.count,\r\n                    expiresAt: result.expires_at\r\n                });\r\n                return { allowed: false, remaining: 0 };\r\n            }\r\n\r\n            /**\r\n             * \u672A\u8FBE\u4E0A\u9650\uFF1A\u9012\u589E\u8BA1\u6570\u5E76\u66F4\u65B0\u65F6\u95F4\u6233\u3002\r\n             *\r\n             * \u8BF4\u660E\uFF1A\r\n             * - UPDATE \u8BED\u53E5\u4EC5\u66F4\u65B0\u8BA1\u6570\u4E0E updated_at\uFF0C\u4E0D\u53D8\u66F4 expires_at\uFF08\u7A97\u53E3\u671F\u8FB9\u754C\u4FDD\u6301\u4E0D\u53D8\uFF09\u3002\r\n             */\r\n            this.ctx.storage.sql.exec(\r\n                `UPDATE rate_limits SET count = count + 1, updated_at = ? WHERE key = ?`,\r\n                now, key\r\n            );\r\n\r\n            const newCount = result.count + 1;\r\n            this.cache.set(key, { count: newCount, expiresAt: result.expires_at });\r\n\r\n            return { allowed: true, remaining: limit - newCount };\r\n        }\r\n\r\n        /**\r\n         * \u8BB0\u5F55\u4E0D\u5B58\u5728\u6216\u5DF2\u8FC7\u671F\uFF1A\u521B\u5EFA/\u91CD\u7F6E\u7A97\u53E3\u671F\u3002\r\n         *\r\n         * \u884C\u4E3A\uFF1A\r\n         * - count \u91CD\u7F6E\u4E3A 1\u3002\r\n         * - expires_at \u8BBE\u4E3A\u65B0\u7684\u7A97\u53E3\u671F\u7ED3\u675F\u65F6\u95F4\u3002\r\n         * - updated_at \u540C\u6B65\u66F4\u65B0\u3002\r\n         */\r\n        this.ctx.storage.sql.exec(\r\n            `INSERT INTO rate_limits (key, count, expires_at, created_at, updated_at)\r\n             VALUES (?, ?, ?, ?, ?)\r\n             ON CONFLICT(key) DO UPDATE SET\r\n             count = 1,\r\n             expires_at = ?,\r\n             updated_at = ?`,\r\n            key, 1, expiresAt, now, now, expiresAt, now\r\n        );\r\n\r\n        this.cache.set(key, { count: 1, expiresAt });\r\n        return { allowed: true, remaining: limit - 1 };\r\n    }\r\n\r\n    /**\r\n     * \u6E05\u7406\u8FC7\u671F\u9650\u6D41\u8BB0\u5F55\uFF08\u5EFA\u8BAE\u7531 alarm \u6216\u5916\u90E8\u8C03\u5EA6\u5468\u671F\u89E6\u53D1\uFF09\u3002\r\n     *\r\n     * \u884C\u4E3A\uFF1A\r\n     * - \u5220\u9664 SQLite \u4E2D expires_at < now \u7684\u8BB0\u5F55\u3002\r\n     * - \u540C\u6B65\u5220\u9664\u7F13\u5B58\u4E2D\u8FC7\u671F\u9879\uFF0C\u907F\u514D\u7F13\u5B58\u81A8\u80C0\u3002\r\n     *\r\n     * \u8FD4\u56DE\uFF1A\r\n     * - deleted\uFF1A\u672C\u6B21\u5220\u9664\u7684\u8BB0\u5F55\u6570\u91CF\uFF08\u4EE5 SQLite meta.changes \u4E3A\u51C6\uFF09\u3002\r\n     */\r\n    async cleanupExpired() {\r\n        const now = Date.now();\r\n        const result = this.ctx.storage.sql.exec(\r\n            `DELETE FROM rate_limits WHERE expires_at < ?`,\r\n            now\r\n        );\r\n\r\n        // \u6E05\u7406\u7F13\u5B58\u4E2D\u8FC7\u671F\u9879\uFF08\u4EC5\u6839\u636E\u7F13\u5B58\u81EA\u8EAB\u7684 expiresAt \u5224\u65AD\uFF09\r\n        for (const [key, value] of this.cache.entries()) {\r\n            if (value.expiresAt < now) {\r\n                this.cache.delete(key);\r\n            }\r\n        }\r\n\r\n        return { deleted: result.meta.changes };\r\n    }\r\n\r\n    /**\r\n     * \u83B7\u53D6\u670D\u52A1\u7EDF\u8BA1\u4FE1\u606F\u3002\r\n     *\r\n     * \u5B57\u6BB5\u8BF4\u660E\uFF1A\r\n     * - totalRecords\uFF1ASQLite \u8868\u5185\u8BB0\u5F55\u603B\u6570\uFF08\u542B\u5DF2\u8FC7\u671F\u4F46\u672A\u6E05\u7406\u7684\u8BB0\u5F55\uFF09\u3002\r\n     * - activeRecords\uFF1A\u672A\u8FC7\u671F\u8BB0\u5F55\u6570\uFF08expires_at > now\uFF09\u3002\r\n     * - cachedItems\uFF1A\u5F53\u524D\u5185\u5B58\u7F13\u5B58\u9879\u6570\u91CF\u3002\r\n     */\r\n    async getStats() {\r\n        const total = this.ctx.storage.sql.exec(\r\n            `SELECT COUNT(*) as count FROM rate_limits`\r\n        ).one();\r\n\r\n        const active = this.ctx.storage.sql.exec(\r\n            `SELECT COUNT(*) as count FROM rate_limits WHERE expires_at > ?`,\r\n            Date.now()\r\n        ).one();\r\n\r\n        return {\r\n            totalRecords: total?.count || 0,\r\n            activeRecords: active?.count || 0,\r\n            cachedItems: this.cache.size\r\n        };\r\n    }\r\n\r\n    /**\r\n     * \u91CD\u7F6E\u6307\u5B9A key \u7684\u9650\u6D41\u72B6\u6001\uFF08\u7BA1\u7406\u7528\u9014\uFF09\u3002\r\n     *\r\n     * \u884C\u4E3A\uFF1A\r\n     * - \u5220\u9664 SQLite \u4E2D\u5BF9\u5E94\u8BB0\u5F55\u3002\r\n     * - \u5220\u9664\u7F13\u5B58\u4E2D\u7684\u5BF9\u5E94\u9879\u3002\r\n     */\r\n    async reset(key) {\r\n        this.ctx.storage.sql.exec(`DELETE FROM rate_limits WHERE key = ?`, key);\r\n        this.cache.delete(key);\r\n        return { success: true };\r\n    }\r\n}\r\n", "export const CONFIG = {\r\n    VERIFY_ID_LENGTH: 12,\r\n    VERIFY_EXPIRE_SECONDS: 300,\r\n    VERIFIED_EXPIRE_SECONDS: 2592000,\r\n    MEDIA_GROUP_EXPIRE_SECONDS: 60,\r\n    MEDIA_GROUP_DELAY_MS: 3000,\r\n    PENDING_MAX_MESSAGES: 10,\r\n    ADMIN_CACHE_TTL_SECONDS: 300,\r\n    NEEDS_REVERIFY_TTL_SECONDS: 600,\r\n    THREAD_HEALTH_TTL_MS: 60000,\r\n    MESSAGE_MAP_TTL_SECONDS: 86400,\r\n    RATE_LIMIT_MESSAGE: 45,\r\n    RATE_LIMIT_VERIFY: 3,\r\n    RATE_LIMIT_WINDOW: 60,\r\n    BUTTON_COLUMNS: 2,\r\n    MAX_TITLE_LENGTH: 128,\r\n    MAX_NAME_LENGTH: 30,\r\n    API_TIMEOUT_MS: 10000,\r\n    CLEANUP_BATCH_SIZE: 10,\r\n    MAX_CLEANUP_DISPLAY: 20,\r\n    CLEANUP_LOCK_TTL_SECONDS: 1800,\r\n    MAX_RETRY_ATTEMPTS: 3,\r\n    D1_WRITE_MAX_RETRIES: 3,\r\n    D1_WRITE_BASE_DELAY_MS: 120,\r\n    D1_WRITE_MAX_DELAY_MS: 1200,\r\n    KEYWORD_MAX_LENGTH: 200,\r\n    KEYWORD_MATCH_MAX_TEXT_LENGTH: 4000\r\n};\r\n\r\nexport const LOCAL_QUESTIONS = [\r\n    { question: \"\u51B0\u878D\u5316\u540E\u4F1A\u53D8\u6210\u4EC0\u4E48\uFF1F\", correct_answer: \"\u6C34\", incorrect_answers: [\"\u77F3\u5934\", \"\u6728\u5934\", \"\u706B\"] },\r\n    { question: \"\u6B63\u5E38\u4EBA\u6709\u51E0\u53EA\u773C\u775B\uFF1F\", correct_answer: \"2\", incorrect_answers: [\"1\", \"3\", \"4\"] },\r\n    { question: \"\u4EE5\u4E0B\u54EA\u4E2A\u5C5E\u4E8E\u6C34\u679C\uFF1F\", correct_answer: \"\u9999\u8549\", incorrect_answers: [\"\u767D\u83DC\", \"\u732A\u8089\", \"\u5927\u7C73\"] },\r\n    { question: \"1 \u52A0 2 \u7B49\u4E8E\u51E0\uFF1F\", correct_answer: \"3\", incorrect_answers: [\"2\", \"4\", \"5\"] },\r\n    { question: \"5 \u51CF 2 \u7B49\u4E8E\u51E0\uFF1F\", correct_answer: \"3\", incorrect_answers: [\"1\", \"2\", \"4\"] },\r\n    { question: \"2 \u4E58\u4EE5 3 \u7B49\u4E8E\u51E0\uFF1F\", correct_answer: \"6\", incorrect_answers: [\"4\", \"5\", \"7\"] },\r\n    { question: \"10 \u52A0 5 \u7B49\u4E8E\u51E0\uFF1F\", correct_answer: \"15\", incorrect_answers: [\"10\", \"12\", \"20\"] },\r\n    { question: \"8 \u51CF 4 \u7B49\u4E8E\u51E0\uFF1F\", correct_answer: \"4\", incorrect_answers: [\"2\", \"3\", \"5\"] },\r\n    { question: \"\u5728\u5929\u4E0A\u98DE\u7684\u4EA4\u901A\u5DE5\u5177\u662F\u4EC0\u4E48\uFF1F\", correct_answer: \"\u98DE\u673A\", incorrect_answers: [\"\u6C7D\u8F66\", \"\u8F6E\u8239\", \"\u81EA\u884C\u8F66\"] },\r\n    { question: \"\u661F\u671F\u4E00\u7684\u540E\u9762\u662F\u661F\u671F\u51E0\uFF1F\", correct_answer: \"\u661F\u671F\u4E8C\", incorrect_answers: [\"\u661F\u671F\u65E5\", \"\u661F\u671F\u4E94\", \"\u661F\u671F\u4E09\"] },\r\n    { question: \"\u9C7C\u901A\u5E38\u751F\u6D3B\u5728\u54EA\u91CC\uFF1F\", correct_answer: \"\u6C34\u91CC\", incorrect_answers: [\"\u6811\u4E0A\", \"\u571F\u91CC\", \"\u706B\u91CC\"] },\r\n    { question: \"\u6211\u4EEC\u7528\u4EC0\u4E48\u5668\u5B98\u6765\u542C\u58F0\u97F3\uFF1F\", correct_answer: \"\u8033\u6735\", incorrect_answers: [\"\u773C\u775B\", \"\u9F3B\u5B50\", \"\u5634\u5DF4\"] },\r\n    { question: \"\u6674\u6717\u7684\u5929\u7A7A\u901A\u5E38\u662F\u4EC0\u4E48\u989C\u8272\u7684\uFF1F\", correct_answer: \"\u84DD\u8272\", incorrect_answers: [\"\u7EFF\u8272\", \"\u7EA2\u8272\", \"\u7D2B\u8272\"] },\r\n    { question: \"\u592A\u9633\u4ECE\u54EA\u4E2A\u65B9\u5411\u5347\u8D77\uFF1F\", correct_answer: \"\u4E1C\u65B9\", incorrect_answers: [\"\u897F\u65B9\", \"\u5357\u65B9\", \"\u5317\u65B9\"] },\r\n    { question: \"\u5C0F\u72D7\u53D1\u51FA\u7684\u53EB\u58F0\u901A\u5E38\u662F\uFF1F\", correct_answer: \"\u6C6A\u6C6A\", incorrect_answers: [\"\u55B5\u55B5\", \"\u54A9\u54A9\", \"\u5471\u5471\"] }\r\n];\r\n", "export const Logger = {\r\n    info(action, data = {}) {\r\n        const log = {\r\n            timestamp: new Date().toISOString(),\r\n            level: 'INFO',\r\n            action,\r\n            ...data\r\n        };\r\n        console.log(JSON.stringify(log));\r\n    },\r\n\r\n    warn(action, data = {}) {\r\n        const log = {\r\n            timestamp: new Date().toISOString(),\r\n            level: 'WARN',\r\n            action,\r\n            ...data\r\n        };\r\n        console.warn(JSON.stringify(log));\r\n    },\r\n\r\n    error(action, error, data = {}) {\r\n        const log = {\r\n            timestamp: new Date().toISOString(),\r\n            level: 'ERROR',\r\n            action,\r\n            error: error instanceof Error ? error.message : String(error),\r\n            stack: error instanceof Error ? error.stack : undefined,\r\n            ...data\r\n        };\r\n        console.error(JSON.stringify(log));\r\n    },\r\n\r\n    debug(action, data = {}) {\r\n        const log = {\r\n            timestamp: new Date().toISOString(),\r\n            level: 'DEBUG',\r\n            action,\r\n            ...data\r\n        };\r\n        console.log(JSON.stringify(log));\r\n    }\r\n};\r\n", "export function secureRandomInt(min, max) {\r\n    const range = max - min;\r\n    const bytes = new Uint32Array(1);\r\n    crypto.getRandomValues(bytes);\r\n    return min + (bytes[0] % range);\r\n}\r\n\r\nexport function secureRandomId(length = 12) {\r\n    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\r\n    const bytes = new Uint8Array(length);\r\n    crypto.getRandomValues(bytes);\r\n    return Array.from(bytes).map(b => chars[b % chars.length]).join('');\r\n}\r\n", "import { CONFIG } from '../config/constants.js';\r\nimport { Logger } from '../core/logger.js';\r\n\r\nexport async function tgCall(env, method, body, timeout = CONFIG.API_TIMEOUT_MS) {\r\n    let base = env.API_BASE || 'https://api.telegram.org';\r\n\r\n    if (base.startsWith('http://')) {\r\n        Logger.warn('api_http_upgraded', { originalBase: base });\r\n        base = base.replace('http://', 'https://');\r\n    }\r\n\r\n    try {\r\n        new URL(`${base}/test`);\r\n    } catch (e) {\r\n        Logger.error('api_base_invalid', e, { base });\r\n        base = 'https://api.telegram.org';\r\n    }\r\n\r\n    const controller = new AbortController();\r\n    const timeoutId = setTimeout(() => controller.abort(), timeout);\r\n\r\n    try {\r\n        const resp = await fetch(`${base}/bot${env.BOT_TOKEN}/${method}`, {\r\n            method: 'POST',\r\n            headers: { 'content-type': 'application/json' },\r\n            body: JSON.stringify(body),\r\n            signal: controller.signal\r\n        });\r\n\r\n        clearTimeout(timeoutId);\r\n\r\n        if (!resp.ok && resp.status >= 500) {\r\n            Logger.warn('telegram_api_server_error', {\r\n                method,\r\n                status: resp.status\r\n            });\r\n        }\r\n\r\n        let result;\r\n        try {\r\n            result = await resp.json();\r\n        } catch (parseError) {\r\n            Logger.error('telegram_api_json_parse_failed', parseError, { method, status: resp.status });\r\n            return { ok: false, description: 'Invalid JSON response from Telegram' };\r\n        }\r\n\r\n        if (!result.ok && result.description && result.description.includes('Too Many Requests')) {\r\n            const retryAfter = result.parameters?.retry_after || 5;\r\n            Logger.warn('telegram_api_rate_limit', {\r\n                method,\r\n                retryAfter\r\n            });\r\n        }\r\n\r\n        return result;\r\n    } catch (e) {\r\n        clearTimeout(timeoutId);\r\n\r\n        if (e.name === 'AbortError') {\r\n            Logger.error('telegram_api_timeout', e, { method, timeout });\r\n            return { ok: false, description: 'Request timeout' };\r\n        }\r\n\r\n        Logger.error('telegram_api_failed', e, { method });\r\n        return { ok: false, description: String(e.message) };\r\n    }\r\n}\r\n", "import { Logger } from '../core/logger.js';\n\r\nexport async function checkRateLimit(userId, env, action = 'message', limit = 20, window = 60) {\r\n    if (!env.RATE_LIMIT_DO) {\r\n        Logger.warn('rate_limit_do_not_configured', { userId, action });\r\n        const key = `ratelimit:${action}:${userId}`;\r\n        const countStr = await env.TOPIC_MAP.get(key);\r\n        const count = parseInt(countStr || '0');\r\n\r\n        if (count >= limit) {\r\n            return { allowed: false, remaining: 0 };\r\n        }\r\n\r\n        await env.TOPIC_MAP.put(key, String(count + 1), { expirationTtl: window });\r\n        return { allowed: true, remaining: limit - count - 1 };\r\n    }\r\n\r\n    try {\r\n        const stub = env.RATE_LIMIT_DO.getByName(String(userId));\r\n        const result = await stub.check(`${action}:${userId}`, limit, window);\r\n        return { allowed: result.allowed, remaining: result.remaining };\r\n    } catch (e) {\r\n        if (e.retryable) {\r\n            Logger.warn('rate_limit_do_retryable_error', { userId, action, error: e.message });\r\n        } else if (e.overloaded) {\r\n            Logger.warn('rate_limit_do_overloaded', { userId, action });\r\n        } else {\r\n            Logger.error('rate_limit_do_call_failed', e, { userId, action });\r\n        }\r\n\r\n        return { allowed: true, remaining: limit };\r\n    }\r\n}\r\n", "import { CONFIG } from '../config/constants.js';\r\nimport { Logger } from '../core/logger.js';\r\n\r\nconst keywordCache = {\r\n    ts: 0,\r\n    list: []\r\n};\r\n\r\nexport function hasD1(env) {\r\n    return !!env.TG_BOT_DB;\r\n}\r\n\r\nfunction shouldRetryD1Error(error) {\r\n    const message = String(error?.message || error || '');\r\n    const retryable = [\r\n        'Network connection lost',\r\n        'Socket was closed',\r\n        'reset because its code was updated',\r\n        'storage reset because its code was updated'\r\n    ];\r\n    return retryable.some((text) => message.includes(text));\r\n}\r\n\r\nasync function runD1Write(env, action, fn) {\r\n    let attempt = 0;\r\n    while (true) {\r\n        try {\r\n            return await fn();\r\n        } catch (e) {\r\n            attempt++;\r\n            const shouldRetry = shouldRetryD1Error(e) && attempt < CONFIG.D1_WRITE_MAX_RETRIES;\r\n            if (!shouldRetry) {\r\n                Logger.error('d1_write_failed', e, { action, attempt });\r\n                throw e;\r\n            }\r\n            const base = CONFIG.D1_WRITE_BASE_DELAY_MS;\r\n            const max = CONFIG.D1_WRITE_MAX_DELAY_MS;\r\n            const delay = Math.min(max, base * (2 ** (attempt - 1)) + Math.floor(Math.random() * base));\r\n            Logger.warn('d1_write_retry', { action, attempt, delay });\r\n            await new Promise(resolve => setTimeout(resolve, delay));\r\n        }\r\n    }\r\n}\r\n\r\nfunction toDbBool(val) {\r\n    return val ? 1 : 0;\r\n}\r\n\r\nfunction normalizeUserRecord(row) {\r\n    if (!row) return null;\r\n    return {\r\n        thread_id: row.thread_id ?? null,\r\n        title: row.title ?? null,\r\n        closed: row.closed ? true : false\r\n    };\r\n}\r\n\r\nasync function ensureUserRow(env, userId) {\r\n    if (!hasD1(env)) return;\r\n    const now = Date.now();\r\n    await runD1Write(env, 'user_insert', async () => {\r\n        await env.TG_BOT_DB\r\n            .prepare('INSERT OR IGNORE INTO users (user_id, created_at, updated_at) VALUES (?, ?, ?)')\r\n            .bind(String(userId), now, now)\r\n            .run();\r\n    });\r\n}\r\n\r\nexport async function dbUserGet(env, userId) {\r\n    if (!hasD1(env)) return null;\r\n    const row = await env.TG_BOT_DB\r\n        .prepare('SELECT user_id, thread_id, title, closed FROM users WHERE user_id = ?')\r\n        .bind(String(userId))\r\n        .first();\r\n    return normalizeUserRecord(row);\r\n}\r\n\r\nexport async function dbUserUpdate(env, userId, data = {}) {\r\n    if (!hasD1(env)) return;\r\n    await ensureUserRow(env, userId);\r\n\r\n    const fields = [];\r\n    const values = [];\r\n\r\n    if ('thread_id' in data) {\r\n        fields.push('thread_id = ?');\r\n        values.push(data.thread_id !== undefined ? (data.thread_id === null ? null : String(data.thread_id)) : null);\r\n    }\r\n    if ('title' in data) {\r\n        fields.push('title = ?');\r\n        values.push(data.title ?? null);\r\n    }\r\n    if ('closed' in data) {\r\n        fields.push('closed = ?');\r\n        values.push(toDbBool(!!data.closed));\r\n    }\r\n    if ('verify_state' in data) {\r\n        fields.push('verify_state = ?');\r\n        values.push(data.verify_state ?? null);\r\n    }\r\n    if ('verify_expires_at' in data) {\r\n        fields.push('verify_expires_at = ?');\r\n        values.push(data.verify_expires_at ?? null);\r\n    }\r\n    if ('is_blocked' in data) {\r\n        fields.push('is_blocked = ?');\r\n        values.push(toDbBool(!!data.is_blocked));\r\n    }\r\n    if ('user_info_json' in data) {\r\n        fields.push('user_info_json = ?');\r\n        values.push(data.user_info_json ?? null);\r\n    }\r\n\r\n    if (fields.length === 0) return;\r\n\r\n    const now = Date.now();\r\n    fields.push('updated_at = ?');\r\n    values.push(now);\r\n\r\n    await runD1Write(env, 'user_update', async () => {\r\n        await env.TG_BOT_DB\r\n            .prepare(`UPDATE users SET ${fields.join(', ')} WHERE user_id = ?`)\r\n            .bind(...values, String(userId))\r\n            .run();\r\n    });\r\n}\r\n\r\nexport async function dbGetVerifyState(env, userId) {\r\n    if (!hasD1(env)) return null;\r\n    const row = await env.TG_BOT_DB\r\n        .prepare('SELECT verify_state, verify_expires_at FROM users WHERE user_id = ?')\r\n        .bind(String(userId))\r\n        .first();\r\n\r\n    if (!row || !row.verify_state) return null;\r\n    if (row.verify_state === 'trusted') return 'trusted';\r\n\r\n    const expiresAt = Number(row.verify_expires_at || 0);\r\n    if (expiresAt && expiresAt < Date.now()) {\r\n        await dbUserUpdate(env, userId, { verify_state: null, verify_expires_at: null });\r\n        return null;\r\n    }\r\n\r\n    return row.verify_state;\r\n}\r\n\r\nexport async function dbSetVerifyState(env, userId, state) {\r\n    if (!hasD1(env)) return;\r\n    if (!state) {\r\n        await dbUserUpdate(env, userId, { verify_state: null, verify_expires_at: null });\r\n        return;\r\n    }\r\n    const now = Date.now();\r\n    const expiresAt = state === 'trusted' ? null : (now + CONFIG.VERIFIED_EXPIRE_SECONDS * 1000);\r\n    await dbUserUpdate(env, userId, { verify_state: state, verify_expires_at: expiresAt });\r\n}\r\n\r\nexport async function dbIsBanned(env, userId) {\r\n    if (!hasD1(env)) return false;\r\n    const row = await env.TG_BOT_DB\r\n        .prepare('SELECT is_blocked FROM users WHERE user_id = ?')\r\n        .bind(String(userId))\r\n        .first();\r\n    return !!(row && row.is_blocked);\r\n}\r\n\r\nexport async function dbSetBanned(env, userId, isBanned) {\r\n    if (!hasD1(env)) return;\r\n    await dbUserUpdate(env, userId, { is_blocked: !!isBanned });\r\n}\r\n\r\nexport async function dbThreadGetUserId(env, threadId) {\r\n    if (!hasD1(env)) return null;\r\n    const row = await env.TG_BOT_DB\r\n        .prepare('SELECT user_id FROM threads WHERE thread_id = ?')\r\n        .bind(String(threadId))\r\n        .first();\r\n    if (row?.user_id) return row.user_id;\r\n\r\n    const fallback = await env.TG_BOT_DB\r\n        .prepare('SELECT user_id FROM users WHERE thread_id = ?')\r\n        .bind(String(threadId))\r\n        .first();\r\n    if (fallback?.user_id) {\r\n        await dbThreadPut(env, threadId, fallback.user_id);\r\n        return fallback.user_id;\r\n    }\r\n    return null;\r\n}\r\n\r\nexport async function dbThreadPut(env, threadId, userId) {\r\n    if (!hasD1(env)) return;\r\n    await runD1Write(env, 'thread_put', async () => {\r\n        await env.TG_BOT_DB\r\n            .prepare('INSERT OR REPLACE INTO threads (thread_id, user_id) VALUES (?, ?)')\r\n            .bind(String(threadId), String(userId))\r\n            .run();\r\n    });\r\n}\r\n\r\nexport async function dbThreadDelete(env, threadId) {\r\n    if (!hasD1(env)) return;\r\n    await runD1Write(env, 'thread_delete', async () => {\r\n        await env.TG_BOT_DB\r\n            .prepare('DELETE FROM threads WHERE thread_id = ?')\r\n            .bind(String(threadId))\r\n            .run();\r\n    });\r\n}\r\n\r\nexport async function dbMessageMapPut(env, sourceChatId, sourceMsgId, targetChatId, targetMsgId) {\r\n    if (!hasD1(env)) return;\r\n    const now = Date.now();\r\n    await runD1Write(env, 'message_map_put', async () => {\r\n        await env.TG_BOT_DB\r\n            .prepare(`INSERT OR REPLACE INTO messages\r\n                (source_chat_id, source_msg_id, target_chat_id, target_msg_id, created_at)\r\n                VALUES (?, ?, ?, ?, ?)`)\r\n            .bind(String(sourceChatId), String(sourceMsgId), String(targetChatId), String(targetMsgId), now)\r\n            .run();\r\n    });\r\n}\r\n\r\nexport async function dbMessageMapGet(env, sourceChatId, sourceMsgId) {\r\n    if (!hasD1(env)) return null;\r\n    const row = await env.TG_BOT_DB\r\n        .prepare(`SELECT target_chat_id, target_msg_id, created_at\r\n                  FROM messages WHERE source_chat_id = ? AND source_msg_id = ?`)\r\n        .bind(String(sourceChatId), String(sourceMsgId))\r\n        .first();\r\n    if (!row) return null;\r\n    return {\r\n        targetChatId: row.target_chat_id,\r\n        targetMsgId: row.target_msg_id,\r\n        createdAt: row.created_at\r\n    };\r\n}\r\n\r\nexport async function dbCount(env, whereSql = '', params = []) {\r\n    if (!hasD1(env)) return 0;\r\n    const sql = `SELECT COUNT(*) AS count FROM users ${whereSql}`;\r\n    const row = await env.TG_BOT_DB.prepare(sql).bind(...params).first();\r\n    return Number(row?.count || 0);\r\n}\r\n\r\nexport async function dbListUsers(env, limit, offset) {\r\n    if (!hasD1(env)) return [];\r\n    const result = await env.TG_BOT_DB\r\n        .prepare('SELECT user_id, thread_id, title, closed FROM users LIMIT ? OFFSET ?')\r\n        .bind(limit, offset)\r\n        .all();\r\n    return result?.results || [];\r\n}\r\n\r\nexport async function dbKeywordList(env) {\r\n    if (!hasD1(env)) return [];\r\n    const result = await env.TG_BOT_DB\r\n        .prepare('SELECT keyword FROM keywords ORDER BY id ASC')\r\n        .all();\r\n    return (result?.results || []).map(row => String(row.keyword)).filter(Boolean);\r\n}\r\n\r\nexport async function dbKeywordListWithId(env) {\r\n    if (!hasD1(env)) return [];\r\n    const result = await env.TG_BOT_DB\r\n        .prepare('SELECT id, keyword FROM keywords ORDER BY id ASC')\r\n        .all();\r\n    return (result?.results || [])\r\n        .map(row => ({ id: Number(row.id), keyword: String(row.keyword) }))\r\n        .filter(row => row.keyword);\r\n}\r\n\r\nexport async function dbKeywordAdd(env, keyword) {\r\n    if (!hasD1(env)) return;\r\n    await runD1Write(env, 'keyword_add', async () => {\r\n        await env.TG_BOT_DB\r\n            .prepare('INSERT OR IGNORE INTO keywords (keyword, created_at) VALUES (?, ?)')\r\n            .bind(String(keyword), Date.now())\r\n            .run();\r\n    });\r\n    keywordCache.ts = 0;\r\n}\r\n\r\nexport async function dbKeywordDelete(env, keyword) {\r\n    if (!hasD1(env)) return 0;\r\n    let changes = 0;\r\n    await runD1Write(env, 'keyword_delete', async () => {\r\n        const result = await env.TG_BOT_DB\r\n            .prepare('DELETE FROM keywords WHERE keyword = ?')\r\n            .bind(String(keyword))\r\n            .run();\r\n        changes = Number(result?.meta?.changes ?? result?.changes ?? 0);\r\n    });\r\n    keywordCache.ts = 0;\r\n    return changes;\r\n}\r\n\r\nexport async function dbKeywordDeleteById(env, id) {\r\n    if (!hasD1(env)) return 0;\r\n    let changes = 0;\r\n    await runD1Write(env, 'keyword_delete', async () => {\r\n        const result = await env.TG_BOT_DB\r\n            .prepare('DELETE FROM keywords WHERE id = ?')\r\n            .bind(Number(id))\r\n            .run();\r\n        changes = Number(result?.meta?.changes ?? result?.changes ?? 0);\r\n    });\r\n    keywordCache.ts = 0;\r\n    return changes;\r\n}\r\n\r\nexport async function getKeywordListCached(env) {\r\n    if (!hasD1(env)) return [];\r\n    const now = Date.now();\r\n    if (keywordCache.ts && (now - keywordCache.ts) < 60000 && keywordCache.list.length) {\r\n        return keywordCache.list;\r\n    }\r\n    const list = await dbKeywordList(env);\r\n    keywordCache.ts = now;\r\n    keywordCache.list = list;\r\n    return list;\r\n}\r\n", "import { CONFIG } from '../config/constants.js';\r\nimport { Logger } from '../core/logger.js';\r\nimport { getKeywordListCached } from '../adapters/storage-d1.js';\r\n\r\nexport function getFilterText(msg) {\r\n    if (msg.text) return String(msg.text);\r\n    if (msg.caption) return String(msg.caption);\r\n    return '';\r\n}\r\n\r\nexport function validateKeywordPattern(raw) {\r\n    const pattern = String(raw || '').trim();\r\n    if (!pattern) return { ok: false, reason: '\u5173\u952E\u8BCD\u4E0D\u80FD\u4E3A\u7A7A' };\r\n    if (pattern.length > CONFIG.KEYWORD_MAX_LENGTH) {\r\n        return { ok: false, reason: `\u5173\u952E\u8BCD\u8FC7\u957F\uFF08\u6700\u5927 ${CONFIG.KEYWORD_MAX_LENGTH} \u5B57\u7B26\uFF09` };\r\n    }\r\n\r\n    const dotAnyCount = (pattern.match(/(\\.\\*|\\.\\+)/g) || []).length;\r\n    if (dotAnyCount > 2) {\r\n        return { ok: false, reason: '\u5305\u542B\u8FC7\u591A\u4EFB\u610F\u5339\u914D\uFF08.* / .+\uFF09' };\r\n    }\r\n\r\n    const nestedQuantifier = /(\\([^)]*[+*][^)]*\\)[+*?]|\\([^)]*\\{[^}]+\\}[^)]*\\)[+*?]|\\([^)]*[+*][^)]*\\)\\{\\d*,?\\d*\\})/;\r\n    if (nestedQuantifier.test(pattern)) {\r\n        return { ok: false, reason: '\u7591\u4F3C\u5D4C\u5957\u91CF\u8BCD' };\r\n    }\r\n\r\n    const repeatWithDotAny = /\\([^)]*(\\.\\*|\\.\\+)[^)]*\\)\\{\\d*,?\\d*\\}/;\r\n    if (repeatWithDotAny.test(pattern)) {\r\n        return { ok: false, reason: '\u5305\u542B\u9AD8\u98CE\u9669\u7684\u91CD\u590D\u5339\u914D\u7ED3\u6784' };\r\n    }\r\n\r\n    return { ok: true, reason: '' };\r\n}\r\n\r\nexport async function matchKeyword(env, text) {\r\n    if (!text) return null;\r\n    const targetText = String(text).slice(0, CONFIG.KEYWORD_MATCH_MAX_TEXT_LENGTH);\r\n    const list = await getKeywordListCached(env);\r\n    if (!list.length) return null;\r\n\r\n    for (const keyword of list) {\r\n        const raw = String(keyword).trim();\r\n        if (!raw) continue;\r\n        const validation = validateKeywordPattern(raw);\r\n        if (!validation.ok) {\r\n            Logger.warn('keyword_pattern_blocked', { keyword: raw, reason: validation.reason });\r\n            continue;\r\n        }\r\n        try {\r\n            const re = new RegExp(raw, 'i');\r\n            if (re.test(targetText)) return keyword;\r\n        } catch {\r\n            Logger.warn('keyword_regex_invalid', { keyword: raw });\r\n        }\r\n    }\r\n\r\n    return null;\r\n}\r\n", "import { CONFIG } from '../config/constants.js';\r\nimport { Logger } from '../core/logger.js';\r\nimport { tgCall } from '../adapters/telegram.js';\r\n\r\nconst adminStatusCache = new Map();\r\n\r\nfunction parseAdminIdAllowlist(env) {\r\n    const raw = (env.ADMIN_IDS || '').toString().trim();\r\n    if (!raw) return new Set();\r\n    return new Set(\r\n        raw\r\n            .split(',')\r\n            .map(s => s.trim())\r\n            .filter(Boolean)\r\n            .filter(v => /^\\d+$/.test(v))\r\n    );\r\n}\r\n\r\nexport async function isAdminUser(env, userId) {\r\n    if (!userId) return false;\r\n\r\n    const allowlist = parseAdminIdAllowlist(env);\r\n    if (allowlist.has(String(userId))) {\r\n        return true;\r\n    }\r\n\r\n    const cacheKey = String(userId);\r\n    const now = Date.now();\r\n    const cached = adminStatusCache.get(cacheKey);\r\n    if (cached && (now - cached.ts < CONFIG.ADMIN_CACHE_TTL_SECONDS * 1000)) {\r\n        return cached.isAdmin;\r\n    }\r\n\r\n    const kvKey = `admin:${userId}`;\r\n    const kvVal = await env.TOPIC_MAP.get(kvKey);\r\n    if (kvVal === '1' || kvVal === '0') {\r\n        const isAdmin = kvVal === '1';\r\n        adminStatusCache.set(cacheKey, { ts: now, isAdmin });\r\n        return isAdmin;\r\n    }\r\n\r\n    try {\r\n        const res = await tgCall(env, 'getChatMember', {\r\n            chat_id: env.SUPERGROUP_ID,\r\n            user_id: userId\r\n        });\r\n\r\n        const status = res.result?.status;\r\n        const isAdmin = res.ok && (status === 'creator' || status === 'administrator');\r\n        await env.TOPIC_MAP.put(kvKey, isAdmin ? '1' : '0', { expirationTtl: CONFIG.ADMIN_CACHE_TTL_SECONDS });\r\n        adminStatusCache.set(cacheKey, { ts: now, isAdmin });\r\n        return isAdmin;\r\n    } catch (e) {\r\n        Logger.warn('admin_check_failed', { userId });\r\n        return false;\r\n    }\r\n}\r\n", "import { Logger } from '../core/logger.js';\r\nimport { tgCall } from '../adapters/telegram.js';\r\n\r\nexport function withMessageThreadId(body, threadId) {\r\n    if (threadId === undefined || threadId === null) return body;\r\n    return { ...body, message_thread_id: threadId };\r\n}\r\n\r\nexport function normalizeTgDescription(description) {\r\n    return (description || '').toString().toLowerCase();\r\n}\r\n\r\nexport function isTopicMissingOrDeleted(description) {\r\n    const desc = normalizeTgDescription(description);\r\n    return desc.includes('thread not found') ||\r\n           desc.includes('topic not found') ||\r\n           desc.includes('message thread not found') ||\r\n           desc.includes('topic deleted') ||\r\n           desc.includes('thread deleted') ||\r\n           desc.includes('forum topic not found') ||\r\n           desc.includes('topic closed permanently');\r\n}\r\n\r\nexport function isTestMessageInvalid(description) {\r\n    const desc = normalizeTgDescription(description);\r\n    return desc.includes('message text is empty') ||\r\n           desc.includes('bad request: message text is empty');\r\n}\r\n\r\nexport async function sendWelcomeCard(env, threadId, userId, userFrom) {\r\n    if (!userFrom) return;\r\n\r\n    const firstName = (userFrom.first_name || '').trim();\r\n    const lastName = (userFrom.last_name || '').trim();\r\n    const userNameStr = userFrom.username ? `@${userFrom.username}` : '\u672A\u8BBE\u7F6E\u7528\u6237\u540D';\r\n    const fullName = (firstName + (lastName ? ' ' + lastName : '')).trim() || '\u533F\u540D\u7528\u6237';\r\n\r\n    const cardText = `\uD83D\uDC64 <b>\u65B0\u7528\u6237\u63A5\u5165</b>\r\n` +\r\n                    `ID: <code>${userId}</code>\r\n` +\r\n                    `\u540D\u5B57: <a href=\"tg://user?id=${userId}\">${fullName}</a>\r\n` +\r\n                    `\u7528\u6237\u540D: ${userNameStr}\r\n` +\r\n                    `#id${userId}`;\r\n\r\n    try {\r\n        await tgCall(env, 'sendMessage', {\r\n            chat_id: env.SUPERGROUP_ID,\r\n            message_thread_id: threadId,\r\n            text: cardText,\r\n            parse_mode: 'HTML'\r\n        });\r\n\r\n        Logger.info('welcome_card_sent', { userId, threadId });\r\n    } catch (e) {\r\n        Logger.warn('welcome_card_send_failed', { userId, threadId, error: e.message });\r\n    }\r\n}\r\n\r\nexport async function probeForumThread(env, expectedThreadId, { userId, reason, doubleCheckOnMissingThreadId = true } = {}) {\r\n    const attemptOnce = async () => {\r\n        const res = await tgCall(env, 'sendMessage', {\r\n            chat_id: env.SUPERGROUP_ID,\r\n            message_thread_id: expectedThreadId,\r\n            text: '\uD83D\uDD0E' // \u5728tg\u53D1\u9001\u7B26\u53F7\u4F5C\u4E3A\u63A2\u6D4B\uFF0C\u8BE5\u7B26\u53F7\u4F1A\u81EA\u52A8\u52A0\u5165\u52A8\u6548\uFF0C\u540E\u7EED\u5E94\u6539\u4E3A\u4F7F\u7528\u7EAF\u6587\u672C\r\n        });\r\n\r\n        const actualThreadId = res.result?.message_thread_id;\r\n        const probeMessageId = res.result?.message_id;\r\n\r\n        if (res.ok && probeMessageId) {\r\n            try {\r\n                await tgCall(env, 'deleteMessage', {\r\n                    chat_id: env.SUPERGROUP_ID,\r\n                    message_id: probeMessageId\r\n                });\r\n            } catch {\r\n                // ignore\r\n            }\r\n        }\r\n\r\n        if (!res.ok) {\r\n            if (isTopicMissingOrDeleted(res.description)) {\r\n                return { status: 'missing', description: res.description };\r\n            }\r\n            if (isTestMessageInvalid(res.description)) {\r\n                return { status: 'probe_invalid', description: res.description };\r\n            }\r\n            return { status: 'unknown_error', description: res.description };\r\n        }\r\n\r\n        if (actualThreadId === undefined || actualThreadId === null) {\r\n            return { status: 'missing_thread_id' };\r\n        }\r\n\r\n        if (Number(actualThreadId) !== Number(expectedThreadId)) {\r\n            return { status: 'redirected', actualThreadId };\r\n        }\r\n\r\n        return { status: 'ok' };\r\n    };\r\n\r\n    const first = await attemptOnce();\r\n    if (first.status !== 'missing_thread_id' || !doubleCheckOnMissingThreadId) {\r\n        return first;\r\n    }\r\n\r\n    const second = await attemptOnce();\r\n    if (second.status === 'missing_thread_id') {\r\n        Logger.warn('probe_missing_thread_id_confirmed', {\r\n            userId,\r\n            expectedThreadId,\r\n            reason\r\n        });\r\n    }\r\n    return second;\r\n}\r\n", "export async function sendVerificationChallengeImpl({\r\n    userId,\r\n    env,\r\n    pendingMsgId,\r\n    safeGetJSON,\r\n    checkRateLimit,\r\n    tgCall,\r\n    Logger,\r\n    CONFIG,\r\n    LOCAL_QUESTIONS,\r\n    secureRandomInt,\r\n    shuffleArray,\r\n    secureRandomId\r\n}) {\r\n    const existingChallenge = await env.TOPIC_MAP.get(`user_challenge:${userId}`);\r\n    if (existingChallenge) {\r\n        const chalKey = `chal:${existingChallenge}`;\r\n        const state = await safeGetJSON(env, chalKey, null);\r\n\r\n        if (!state || state.userId !== userId) {\r\n            await env.TOPIC_MAP.delete(`user_challenge:${userId}`);\r\n        } else {\r\n            if (pendingMsgId) {\r\n                let pendingIds = [];\r\n                if (Array.isArray(state.pending_ids)) {\r\n                    pendingIds = state.pending_ids.slice();\r\n                } else if (state.pending) {\r\n                    pendingIds = [state.pending];\r\n                }\r\n\r\n                if (!pendingIds.includes(pendingMsgId)) {\r\n                    pendingIds.push(pendingMsgId);\r\n                    if (pendingIds.length > CONFIG.PENDING_MAX_MESSAGES) {\r\n                        pendingIds = pendingIds.slice(pendingIds.length - CONFIG.PENDING_MAX_MESSAGES);\r\n                    }\r\n                    state.pending_ids = pendingIds;\r\n                    delete state.pending;\r\n                    await env.TOPIC_MAP.put(chalKey, JSON.stringify(state), { expirationTtl: CONFIG.VERIFY_EXPIRE_SECONDS });\r\n                }\r\n            }\r\n            Logger.debug('verification_duplicate_skipped', { userId, verifyId: existingChallenge, hasPending: !!pendingMsgId });\r\n            return;\r\n        }\r\n    }\r\n\r\n    const verifyLimit = await checkRateLimit(userId, env, 'verify', CONFIG.RATE_LIMIT_VERIFY, 300);\r\n    if (!verifyLimit.allowed) {\r\n        await tgCall(env, 'sendMessage', {\r\n            chat_id: userId,\r\n            text: '\u26A0\uFE0F \u9A8C\u8BC1\u8BF7\u6C42\u8FC7\u4E8E\u9891\u7E41\uFF0C\u8BF75\u5206\u949F\u540E\u518D\u8BD5\u3002'\r\n        });\r\n        return;\r\n    }\r\n\r\n    const q = LOCAL_QUESTIONS[secureRandomInt(0, LOCAL_QUESTIONS.length)];\r\n    const challenge = {\r\n        question: q.question,\r\n        correct: q.correct_answer,\r\n        options: shuffleArray([...q.incorrect_answers, q.correct_answer])\r\n    };\r\n\r\n    const verifyId = secureRandomId(CONFIG.VERIFY_ID_LENGTH);\r\n    const answerIndex = challenge.options.indexOf(challenge.correct);\r\n\r\n    const state = {\r\n        answerIndex,\r\n        options: challenge.options,\r\n        pending_ids: pendingMsgId ? [pendingMsgId] : [],\r\n        userId\r\n    };\r\n\r\n    await env.TOPIC_MAP.put(`chal:${verifyId}`, JSON.stringify(state), { expirationTtl: CONFIG.VERIFY_EXPIRE_SECONDS });\r\n    await env.TOPIC_MAP.put(`user_challenge:${userId}`, verifyId, { expirationTtl: CONFIG.VERIFY_EXPIRE_SECONDS });\r\n\r\n    Logger.info('verification_sent', {\r\n        userId,\r\n        verifyId,\r\n        question: q.question,\r\n        pendingCount: state.pending_ids.length\r\n    });\r\n\r\n    const buttons = challenge.options.map((opt, idx) => ({\r\n        text: opt,\r\n        callback_data: `verify:${verifyId}:${idx}`\r\n    }));\r\n\r\n    const keyboard = [];\r\n    for (let i = 0; i < buttons.length; i += CONFIG.BUTTON_COLUMNS) {\r\n        keyboard.push(buttons.slice(i, i + CONFIG.BUTTON_COLUMNS));\r\n    }\r\n\r\n    await tgCall(env, 'sendMessage', {\r\n        chat_id: userId,\r\n        text: `\uD83D\uDEE1\uFE0F **\u4EBA\u673A\u9A8C\u8BC1**\r\n\r\n${challenge.question}\r\n\r\n\u8BF7\u70B9\u51FB\u4E0B\u65B9\u6309\u94AE\u56DE\u7B54 (\u56DE\u7B54\u6B63\u786E\u540E\u5C06\u81EA\u52A8\u53D1\u9001\u60A8\u521A\u624D\u7684\u6D88\u606F)\u3002`,\r\n        parse_mode: 'Markdown',\r\n        reply_markup: { inline_keyboard: keyboard }\r\n    });\r\n}\r\n\r\nexport async function handleCallbackQueryImpl({\r\n    query,\r\n    env,\r\n    ctx,\r\n    tgCall,\r\n    Logger,\r\n    hasD1,\r\n    dbSetVerifyState,\r\n    CONFIG,\r\n    forwardToTopic\r\n}) {\r\n    try {\r\n        const data = query.data;\r\n        if (!data.startsWith('verify:')) return;\r\n\r\n        const parts = data.split(':');\r\n        if (parts.length !== 3) return;\r\n\r\n        const verifyId = parts[1];\r\n        const selectedIndex = parseInt(parts[2]);\r\n        const userId = query.from.id;\r\n\r\n        const stateStr = await env.TOPIC_MAP.get(`chal:${verifyId}`);\r\n        if (!stateStr) {\r\n            await tgCall(env, 'answerCallbackQuery', {\r\n                callback_query_id: query.id,\r\n                text: '\u274C \u9A8C\u8BC1\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u91CD\u53D1\u6D88\u606F',\r\n                show_alert: true\r\n            });\r\n            return;\r\n        }\r\n\r\n        let state;\r\n        try {\r\n            state = JSON.parse(stateStr);\r\n        } catch {\r\n            await tgCall(env, 'answerCallbackQuery', {\r\n                callback_query_id: query.id,\r\n                text: '\u274C \u6570\u636E\u9519\u8BEF',\r\n                show_alert: true\r\n            });\r\n            return;\r\n        }\r\n\r\n        if (state.userId && state.userId !== userId) {\r\n            await tgCall(env, 'answerCallbackQuery', {\r\n                callback_query_id: query.id,\r\n                text: '\u274C \u65E0\u6548\u7684\u9A8C\u8BC1',\r\n                show_alert: true\r\n            });\r\n            return;\r\n        }\r\n\r\n        if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= state.options.length) {\r\n            await tgCall(env, 'answerCallbackQuery', {\r\n                callback_query_id: query.id,\r\n                text: '\u274C \u65E0\u6548\u9009\u9879',\r\n                show_alert: true\r\n            });\r\n            return;\r\n        }\r\n\r\n        if (selectedIndex === state.answerIndex) {\r\n            await tgCall(env, 'answerCallbackQuery', {\r\n                callback_query_id: query.id,\r\n                text: '\u2705 \u9A8C\u8BC1\u901A\u8FC7'\r\n            });\r\n\r\n            Logger.info('verification_passed', {\r\n                userId,\r\n                verifyId,\r\n                selectedOption: state.options[selectedIndex]\r\n            });\r\n\r\n            if (hasD1(env)) {\r\n                await dbSetVerifyState(env, userId, '1');\r\n            } else {\r\n                await env.TOPIC_MAP.put(`verified:${userId}`, '1', { expirationTtl: CONFIG.VERIFIED_EXPIRE_SECONDS });\r\n            }\r\n            await env.TOPIC_MAP.delete(`needs_verify:${userId}`);\r\n\r\n            await env.TOPIC_MAP.delete(`chal:${verifyId}`);\r\n            await env.TOPIC_MAP.delete(`user_challenge:${userId}`);\r\n\r\n            await tgCall(env, 'editMessageText', {\r\n                chat_id: userId,\r\n                message_id: query.message.message_id,\r\n                text: `\u2705 **\u9A8C\u8BC1\u6210\u529F**\\n\\n\u60A8\u73B0\u5728\u53EF\u4EE5\u81EA\u7531\u5BF9\u8BDD\u4E86\u3002`,\r\n                parse_mode: 'Markdown'\r\n            });\r\n\r\n            const hasPending = (Array.isArray(state.pending_ids) && state.pending_ids.length > 0) || !!state.pending;\r\n            if (hasPending) {\r\n                try {\r\n                    let pendingIds = [];\r\n                    if (Array.isArray(state.pending_ids)) {\r\n                        pendingIds = state.pending_ids.slice();\r\n                    } else if (state.pending) {\r\n                        pendingIds = [state.pending];\r\n                    }\r\n\r\n                    if (pendingIds.length > CONFIG.PENDING_MAX_MESSAGES) {\r\n                        pendingIds = pendingIds.slice(pendingIds.length - CONFIG.PENDING_MAX_MESSAGES);\r\n                    }\r\n\r\n                    let forwardedCount = 0;\r\n                    for (const pendingId of pendingIds) {\r\n                        if (!pendingId) continue;\r\n                        const forwardedKey = `forwarded:${userId}:${pendingId}`;\r\n                        const alreadyForwarded = await env.TOPIC_MAP.get(forwardedKey);\r\n                        if (alreadyForwarded) {\r\n                            Logger.info('message_forward_duplicate_skipped', { userId, messageId: pendingId });\r\n                            continue;\r\n                        }\r\n\r\n                        const fakeMsg = {\r\n                            message_id: pendingId,\r\n                            chat: { id: userId, type: 'private' },\r\n                            from: query.from\r\n                        };\r\n\r\n                        await forwardToTopic(fakeMsg, env, ctx);\r\n                        await env.TOPIC_MAP.put(forwardedKey, '1', { expirationTtl: 3600 });\r\n                        forwardedCount++;\r\n                    }\r\n\r\n                    if (forwardedCount > 0) {\r\n                        await tgCall(env, 'sendMessage', {\r\n                            chat_id: userId,\r\n                            text: `\uD83D\uDCE9 \u521A\u624D\u7684 ${forwardedCount} \u6761\u6D88\u606F\u5DF2\u5E2E\u60A8\u9001\u8FBE\u3002`\r\n                        });\r\n                    }\r\n                } catch (e) {\r\n                    Logger.error('pending_message_forward_failed', e, { userId });\r\n                    await tgCall(env, 'sendMessage', {\r\n                        chat_id: userId,\r\n                        text: '\u26A0\uFE0F \u81EA\u52A8\u53D1\u9001\u5931\u8D25\uFF0C\u8BF7\u91CD\u65B0\u53D1\u9001\u60A8\u7684\u6D88\u606F\u3002'\r\n                    });\r\n                }\r\n            }\r\n        } else {\r\n            Logger.info('verification_failed', {\r\n                userId,\r\n                verifyId,\r\n                selectedIndex,\r\n                correctIndex: state.answerIndex\r\n            });\r\n\r\n            await tgCall(env, 'answerCallbackQuery', {\r\n                callback_query_id: query.id,\r\n                text: '\u274C \u7B54\u6848\u9519\u8BEF',\r\n                show_alert: true\r\n            });\r\n        }\r\n    } catch (e) {\r\n        Logger.error('callback_query_error', e, {\r\n            userId: query.from?.id,\r\n            callbackData: query.data\r\n        });\r\n        await tgCall(env, 'answerCallbackQuery', {\r\n            callback_query_id: query.id,\r\n            text: '\u26A0\uFE0F \u7CFB\u7EDF\u9519\u8BEF\uFF0C\u8BF7\u91CD\u8BD5',\r\n            show_alert: true\r\n        });\r\n    }\r\n}\r\n", "export async function handleMediaGroupImpl({\r\n    msg,\r\n    env,\r\n    ctx,\r\n    direction,\r\n    targetChat,\r\n    threadId,\r\n    tgCall,\r\n    withMessageThreadId,\r\n    safeGetJSON,\r\n    delaySend,\r\n    CONFIG\r\n}) {\r\n    const groupId = msg.media_group_id;\r\n    const key = `mg:${direction}:${groupId}`;\r\n    const item = extractMedia(msg);\r\n    if (!item) {\r\n        await tgCall(env, 'copyMessage', withMessageThreadId({\r\n            chat_id: targetChat,\r\n            from_chat_id: msg.chat.id,\r\n            message_id: msg.message_id\r\n        }, threadId));\r\n        return;\r\n    }\r\n    let rec = await safeGetJSON(env, key, null);\r\n    if (!rec) rec = { direction, targetChat, threadId: (threadId === null ? undefined : threadId), items: [], last_ts: Date.now() };\r\n    rec.items.push({ ...item, msg_id: msg.message_id });\r\n    rec.last_ts = Date.now();\r\n    await env.TOPIC_MAP.put(key, JSON.stringify(rec), { expirationTtl: CONFIG.MEDIA_GROUP_EXPIRE_SECONDS });\r\n    ctx.waitUntil(delaySend(env, key, rec.last_ts));\r\n}\r\n\r\nfunction extractMedia(msg) {\r\n    if (msg.photo && msg.photo.length > 0) {\r\n        const highestResolution = msg.photo[msg.photo.length - 1];\r\n        return {\r\n            type: 'photo',\r\n            id: highestResolution.file_id,\r\n            cap: msg.caption || ''\r\n        };\r\n    }\r\n\r\n    if (msg.video) {\r\n        return {\r\n            type: 'video',\r\n            id: msg.video.file_id,\r\n            cap: msg.caption || ''\r\n        };\r\n    }\r\n\r\n    if (msg.document) {\r\n        return {\r\n            type: 'document',\r\n            id: msg.document.file_id,\r\n            cap: msg.caption || ''\r\n        };\r\n    }\r\n\r\n    if (msg.audio) {\r\n        return {\r\n            type: 'audio',\r\n            id: msg.audio.file_id,\r\n            cap: msg.caption || ''\r\n        };\r\n    }\r\n\r\n    if (msg.animation) {\r\n        return {\r\n            type: 'animation',\r\n            id: msg.animation.file_id,\r\n            cap: msg.caption || ''\r\n        };\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\nexport async function flushExpiredMediaGroupsImpl({ env, now, getAllKeys, safeGetJSON, Logger }) {\r\n    try {\r\n        const prefix = 'mg:';\r\n        const allKeys = await getAllKeys(env, prefix);\r\n        let deletedCount = 0;\r\n\r\n        for (const { name } of allKeys) {\r\n            const rec = await safeGetJSON(env, name, null);\r\n            if (rec && rec.last_ts && (now - rec.last_ts > 300000)) {\r\n                await env.TOPIC_MAP.delete(name);\r\n                deletedCount++;\r\n            }\r\n        }\r\n\r\n        if (deletedCount > 0) {\r\n            Logger.info('media_groups_cleaned', { deletedCount });\r\n        }\r\n    } catch (e) {\r\n        Logger.error('media_group_cleanup_failed', e);\r\n    }\r\n}\r\n\r\nexport async function delaySendImpl({\r\n    env,\r\n    key,\r\n    ts,\r\n    CONFIG,\r\n    safeGetJSON,\r\n    Logger,\r\n    tgCall,\r\n    withMessageThreadId\r\n}) {\r\n    await new Promise(r => setTimeout(r, CONFIG.MEDIA_GROUP_DELAY_MS));\r\n\r\n    const rec = await safeGetJSON(env, key, null);\r\n\r\n    if (rec && rec.last_ts === ts) {\r\n        if (!rec.items || rec.items.length === 0) {\r\n            Logger.warn('media_group_empty', { key });\r\n            await env.TOPIC_MAP.delete(key);\r\n            return;\r\n        }\r\n\r\n        const media = rec.items.map((it, i) => {\r\n            if (!it.type || !it.id) {\r\n                Logger.warn('media_group_invalid_item', { key, item: it });\r\n                return null;\r\n            }\r\n            const caption = i === 0 ? (it.cap || '').substring(0, 1024) : '';\r\n            return {\r\n                type: it.type,\r\n                media: it.id,\r\n                caption\r\n            };\r\n        }).filter(Boolean);\r\n\r\n        if (media.length > 0) {\r\n            try {\r\n                const result = await tgCall(env, 'sendMediaGroup', withMessageThreadId({\r\n                    chat_id: rec.targetChat,\r\n                    media\r\n                }, rec.threadId));\r\n\r\n                if (!result.ok) {\r\n                    Logger.error('media_group_send_failed', result.description, {\r\n                        key,\r\n                        mediaCount: media.length\r\n                    });\r\n                } else {\r\n                    Logger.info('media_group_sent', {\r\n                        key,\r\n                        mediaCount: media.length,\r\n                        targetChat: rec.targetChat\r\n                    });\r\n                }\r\n            } catch (e) {\r\n                Logger.error('media_group_send_exception', e, { key });\r\n            }\r\n        }\r\n\r\n        await env.TOPIC_MAP.delete(key);\r\n    }\r\n}\r\n", "export async function handleCleanupCommandImpl({\r\n    threadId,\r\n    env,\r\n    CONFIG,\r\n    hasD1,\r\n    dbListUsers,\r\n    probeForumThread,\r\n    resetUserVerificationAndRequireReverify,\r\n    Logger,\r\n    safeGetJSON,\r\n    deleteBulk,\r\n    tgCall,\r\n    withMessageThreadId\r\n}) {\r\n    const lockKey = 'cleanup:lock';\r\n    const locked = await env.TOPIC_MAP.get(lockKey);\r\n    if (locked) {\r\n        await tgCall(env, 'sendMessage', withMessageThreadId({\r\n            chat_id: env.SUPERGROUP_ID,\r\n            text: '\u23F3 **\u5DF2\u6709\u6E05\u7406\u4EFB\u52A1\u6B63\u5728\u8FD0\u884C\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002**',\r\n            parse_mode: 'Markdown'\r\n        }, threadId));\r\n        return;\r\n    }\r\n\r\n    await env.TOPIC_MAP.put(lockKey, '1', { expirationTtl: CONFIG.CLEANUP_LOCK_TTL_SECONDS });\r\n\r\n    await tgCall(env, 'sendMessage', withMessageThreadId({\r\n        chat_id: env.SUPERGROUP_ID,\r\n        text: '\uD83D\uDD04 **\u6B63\u5728\u626B\u63CF\u9700\u8981\u6E05\u7406\u7684\u7528\u6237...**',\r\n        parse_mode: 'Markdown'\r\n    }, threadId));\r\n\r\n    let cleanedCount = 0;\r\n    let errorCount = 0;\r\n    const cleanedUsers = [];\r\n    let scannedCount = 0;\r\n\r\n    try {\r\n        if (hasD1(env)) {\r\n            let offset = 0;\r\n            while (true) {\r\n                const rows = await dbListUsers(env, CONFIG.CLEANUP_BATCH_SIZE, offset);\r\n                if (!rows.length) break;\r\n                scannedCount += rows.length;\r\n\r\n                const results = await Promise.allSettled(\r\n                    rows.map(async (row) => {\r\n                        if (!row.thread_id) return null;\r\n                        const userId = row.user_id;\r\n                        const topicThreadId = row.thread_id;\r\n\r\n                        const probe = await probeForumThread(env, topicThreadId, {\r\n                            userId,\r\n                            reason: 'cleanup_check',\r\n                            doubleCheckOnMissingThreadId: false\r\n                        });\r\n\r\n                        if (probe.status === 'redirected' || probe.status === 'missing') {\r\n                            await resetUserVerificationAndRequireReverify(env, {\r\n                                userId,\r\n                                userKey: null,\r\n                                oldThreadId: topicThreadId,\r\n                                pendingMsgId: null,\r\n                                reason: 'cleanup_check'\r\n                            });\r\n\r\n                            return {\r\n                                userId,\r\n                                threadId: topicThreadId,\r\n                                title: row.title || '\u672A\u77E5'\r\n                            };\r\n                        } else if (probe.status === 'probe_invalid') {\r\n                            Logger.warn('cleanup_probe_invalid_message', {\r\n                                userId,\r\n                                threadId: topicThreadId,\r\n                                errorDescription: probe.description\r\n                            });\r\n                        } else if (probe.status === 'unknown_error') {\r\n                            Logger.warn('cleanup_probe_failed_unknown', {\r\n                                userId,\r\n                                threadId: topicThreadId,\r\n                                errorDescription: probe.description\r\n                            });\r\n                        } else if (probe.status === 'missing_thread_id') {\r\n                            Logger.warn('cleanup_probe_missing_thread_id', { userId, threadId: topicThreadId });\r\n                        }\r\n\r\n                        return null;\r\n                    })\r\n                );\r\n\r\n                results.forEach(result => {\r\n                    if (result.status === 'fulfilled' && result.value) {\r\n                        cleanedCount++;\r\n                        cleanedUsers.push(result.value);\r\n                        Logger.info('cleanup_user', {\r\n                            userId: result.value.userId,\r\n                            threadId: result.value.threadId\r\n                        });\r\n                    } else if (result.status === 'rejected') {\r\n                        errorCount++;\r\n                        Logger.error('cleanup_batch_error', result.reason);\r\n                    }\r\n                });\r\n\r\n                offset += rows.length;\r\n                await new Promise(r => setTimeout(r, 200));\r\n            }\r\n        } else {\r\n            const keysToDelete = [];\r\n            let cursor = undefined;\r\n            do {\r\n                const result = await env.TOPIC_MAP.list({ prefix: 'user:', cursor });\r\n                const names = (result.keys || []).map(k => k.name);\r\n                scannedCount += names.length;\r\n\r\n                for (let i = 0; i < names.length; i += CONFIG.CLEANUP_BATCH_SIZE) {\r\n                    const batch = names.slice(i, i + CONFIG.CLEANUP_BATCH_SIZE);\r\n\r\n                    const results = await Promise.allSettled(\r\n                        batch.map(async (name) => {\r\n                            const rec = await safeGetJSON(env, name, null);\r\n                            if (!rec || !rec.thread_id) return null;\r\n\r\n                            const userId = name.slice(5);\r\n                            const topicThreadId = rec.thread_id;\r\n\r\n                            const probe = await probeForumThread(env, topicThreadId, {\r\n                                userId,\r\n                                reason: 'cleanup_check',\r\n                                doubleCheckOnMissingThreadId: false\r\n                            });\r\n\r\n                            if (probe.status === 'redirected' || probe.status === 'missing') {\r\n                                keysToDelete.push(\r\n                                    name,\r\n                                    `verified:${userId}`,\r\n                                    `thread:${topicThreadId}`\r\n                                );\r\n\r\n                                return {\r\n                                    userId,\r\n                                    threadId: topicThreadId,\r\n                                    title: rec.title || '\u672A\u77E5'\r\n                                };\r\n                            } else if (probe.status === 'probe_invalid') {\r\n                                Logger.warn('cleanup_probe_invalid_message', {\r\n                                    userId,\r\n                                    threadId: topicThreadId,\r\n                                    errorDescription: probe.description\r\n                                });\r\n                            } else if (probe.status === 'unknown_error') {\r\n                                Logger.warn('cleanup_probe_failed_unknown', {\r\n                                    userId,\r\n                                    threadId: topicThreadId,\r\n                                    errorDescription: probe.description\r\n                                });\r\n                            } else if (probe.status === 'missing_thread_id') {\r\n                                Logger.warn('cleanup_probe_missing_thread_id', { userId, threadId: topicThreadId });\r\n                            }\r\n\r\n                            return null;\r\n                        })\r\n                    );\r\n\r\n                    results.forEach(result => {\r\n                        if (result.status === 'fulfilled' && result.value) {\r\n                            cleanedCount++;\r\n                            cleanedUsers.push(result.value);\r\n                            Logger.info('cleanup_user', {\r\n                                userId: result.value.userId,\r\n                                threadId: result.value.threadId\r\n                            });\r\n                        } else if (result.status === 'rejected') {\r\n                            errorCount++;\r\n                            Logger.error('cleanup_batch_error', result.reason);\r\n                        }\r\n                    });\r\n\r\n                    if (i + CONFIG.CLEANUP_BATCH_SIZE < names.length) {\r\n                        await new Promise(r => setTimeout(r, 600));\r\n                    }\r\n                }\r\n\r\n                cursor = result.list_complete ? undefined : result.cursor;\r\n\r\n                if (cursor) {\r\n                    await new Promise(r => setTimeout(r, 200));\r\n                }\r\n            } while (cursor);\r\n\r\n            if (keysToDelete.length > 0) {\r\n                const deletedCount = await deleteBulk(env, keysToDelete);\r\n                Logger.info('cleanup_bulk_delete', { deletedKeyCount: deletedCount });\r\n            }\r\n        }\r\n\r\n        let reportText = `\u2705 **\u6E05\u7406\u5B8C\u6210**\r\n\r\n`;\r\n        reportText += `\uD83D\uDCCA **\u7EDF\u8BA1\u4FE1\u606F**\r\n`;\r\n        reportText += `- \u626B\u63CF\u7528\u6237\u6570: ${scannedCount}\r\n`;\r\n        reportText += `- \u5DF2\u6E05\u7406\u7528\u6237\u6570: ${cleanedCount}\r\n`;\r\n        reportText += `- \u9519\u8BEF\u6570: ${errorCount}\r\n\r\n`;\r\n\r\n        if (cleanedCount > 0) {\r\n            reportText += `\uD83D\uDDD1\uFE0F **\u5DF2\u6E05\u7406\u7684\u7528\u6237** (\u8BDD\u9898\u5DF2\u5220\u9664):\r\n`;\r\n            for (const user of cleanedUsers.slice(0, CONFIG.MAX_CLEANUP_DISPLAY)) {\r\n                reportText += `- UID: \\`${user.userId}\\` | \u8BDD\u9898: ${user.title}\r\n`;\r\n            }\r\n            if (cleanedUsers.length > CONFIG.MAX_CLEANUP_DISPLAY) {\r\n                reportText += `\r\n...(\u8FD8\u6709 ${cleanedUsers.length - CONFIG.MAX_CLEANUP_DISPLAY} \u4E2A\u7528\u6237)\r\n`;\r\n            }\r\n            reportText += `\r\n\uD83D\uDCA1 \u8FD9\u4E9B\u7528\u6237\u4E0B\u6B21\u53D1\u6D88\u606F\u65F6\u5C06\u91CD\u65B0\u8FDB\u884C\u4EBA\u673A\u9A8C\u8BC1\u5E76\u521B\u5EFA\u65B0\u8BDD\u9898\u3002`;\r\n        } else {\r\n            reportText += `\u2728 \u6CA1\u6709\u53D1\u73B0\u9700\u8981\u6E05\u7406\u7684\u7528\u6237\u8BB0\u5F55\u3002`;\r\n        }\r\n\r\n        Logger.info('cleanup_completed', {\r\n            cleanedCount,\r\n            errorCount,\r\n            totalUsers: scannedCount\r\n        });\r\n\r\n        await tgCall(env, 'sendMessage', withMessageThreadId({\r\n            chat_id: env.SUPERGROUP_ID,\r\n            text: reportText,\r\n            parse_mode: 'Markdown'\r\n        }, threadId));\r\n\r\n    } catch (e) {\r\n        Logger.error('cleanup_failed', e, { threadId });\r\n        await tgCall(env, 'sendMessage', withMessageThreadId({\r\n            chat_id: env.SUPERGROUP_ID,\r\n            text: `\u274C **\u6E05\u7406\u8FC7\u7A0B\u51FA\u9519**\r\n\r\n\u9519\u8BEF\u4FE1\u606F: \\`${e.message}\\``,\r\n            parse_mode: 'Markdown'\r\n        }, threadId));\r\n    } finally {\r\n        await env.TOPIC_MAP.delete(lockKey);\r\n    }\r\n}\r\n", "export async function getOrCreateUserTopicRecImpl({\r\n    from,\r\n    key,\r\n    env,\r\n    userId,\r\n    hasD1,\r\n    dbUserGet,\r\n    safeGetJSON,\r\n    createTopic,\r\n    topicCreateInFlight\r\n}) {\r\n    if (hasD1(env)) {\r\n        const existing = await dbUserGet(env, userId);\r\n        if (existing && existing.thread_id) return existing;\r\n    } else {\r\n        const existing = await safeGetJSON(env, key, null);\r\n        if (existing && existing.thread_id) return existing;\r\n    }\r\n\r\n    const inflight = topicCreateInFlight.get(String(userId));\r\n    if (inflight) return await inflight;\r\n\r\n    const p = (async () => {\r\n        if (hasD1(env)) {\r\n            const again = await dbUserGet(env, userId);\r\n            if (again && again.thread_id) return again;\r\n        } else {\r\n            const again = await safeGetJSON(env, key, null);\r\n            if (again && again.thread_id) return again;\r\n        }\r\n        return await createTopic(from, key, env, userId);\r\n    })();\r\n\r\n    topicCreateInFlight.set(String(userId), p);\r\n    try {\r\n        return await p;\r\n    } finally {\r\n        if (topicCreateInFlight.get(String(userId)) === p) {\r\n            topicCreateInFlight.delete(String(userId));\r\n        }\r\n    }\r\n}\r\n\r\nexport async function resetUserVerificationAndRequireReverifyImpl({\r\n    env,\r\n    userId,\r\n    userKey,\r\n    oldThreadId,\r\n    pendingMsgId,\r\n    reason,\r\n    hasD1,\r\n    dbUserUpdate,\r\n    dbThreadDelete,\r\n    CONFIG,\r\n    threadHealthCache,\r\n    Logger,\r\n    sendVerificationChallenge\r\n}) {\r\n    if (hasD1(env)) {\r\n        await dbUserUpdate(env, userId, { verify_state: null, verify_expires_at: null });\r\n    } else {\r\n        await env.TOPIC_MAP.delete(`verified:${userId}`);\r\n    }\r\n    await env.TOPIC_MAP.put(`needs_verify:${userId}`, '1', { expirationTtl: CONFIG.NEEDS_REVERIFY_TTL_SECONDS });\r\n    await env.TOPIC_MAP.delete(`retry:${userId}`);\r\n\r\n    if (userKey) {\r\n        if (hasD1(env)) {\r\n            await dbUserUpdate(env, userId, { thread_id: null, title: null, closed: false });\r\n        } else {\r\n            await env.TOPIC_MAP.delete(userKey);\r\n        }\r\n    }\r\n\r\n    if (oldThreadId !== undefined && oldThreadId !== null) {\r\n        if (hasD1(env)) {\r\n            await dbThreadDelete(env, oldThreadId);\r\n        } else {\r\n            await env.TOPIC_MAP.delete(`thread:${oldThreadId}`);\r\n        }\r\n        await env.TOPIC_MAP.delete(`thread_ok:${oldThreadId}`);\r\n        threadHealthCache.delete(oldThreadId);\r\n    }\r\n\r\n    Logger.info('verification_reset_due_to_topic_loss', {\r\n        userId,\r\n        oldThreadId,\r\n        pendingMsgId,\r\n        reason\r\n    });\r\n\r\n    await sendVerificationChallenge(userId, env, pendingMsgId || null);\r\n}\r\n\r\nexport function buildTopicTitleImpl(from, CONFIG) {\r\n    const firstName = (from.first_name || '').trim().substring(0, CONFIG.MAX_NAME_LENGTH);\r\n    const lastName = (from.last_name || '').trim().substring(0, CONFIG.MAX_NAME_LENGTH);\r\n\r\n    let username = '';\r\n    if (from.username) {\r\n        username = from.username\r\n            .replace(/[^\\w]/g, '')\r\n            .substring(0, 20);\r\n    }\r\n\r\n    const cleanName = (firstName + ' ' + lastName)\r\n        .replace(/[\\u0000-\\u001F\\u007F-\\u009F]/g, '')\r\n        .replace(/\\s+/g, ' ')\r\n        .trim();\r\n\r\n    const name = cleanName || 'User';\r\n    const usernameStr = username ? ` @${username}` : '';\r\n\r\n    const title = (name + usernameStr).substring(0, CONFIG.MAX_TITLE_LENGTH);\r\n    return title;\r\n}\r\n\r\nexport async function createTopicImpl({\r\n    from,\r\n    key,\r\n    env,\r\n    userId,\r\n    CONFIG,\r\n    tgCall,\r\n    hasD1,\r\n    dbUserUpdate,\r\n    dbThreadPut,\r\n    putWithMetadata,\r\n    buildTopicTitle\r\n}) {\r\n    const title = buildTopicTitle(from);\r\n    if (!env.SUPERGROUP_ID.toString().startsWith('-100')) throw new Error('SUPERGROUP_ID\u5FC5\u987B\u4EE5-100\u5F00\u5934');\r\n    const res = await tgCall(env, 'createForumTopic', { chat_id: env.SUPERGROUP_ID, name: title });\r\n    if (!res.ok) throw new Error(`\u521B\u5EFA\u8BDD\u9898\u5931\u8D25: ${res.description}`);\r\n\r\n    const rec = { thread_id: res.result.message_thread_id, title, closed: false };\r\n\r\n    if (hasD1(env)) {\r\n        await dbUserUpdate(env, userId, {\r\n            thread_id: rec.thread_id,\r\n            title: rec.title,\r\n            closed: false\r\n        });\r\n        if (userId) {\r\n            await dbThreadPut(env, rec.thread_id, userId);\r\n        }\r\n    } else {\r\n        await putWithMetadata(env, key, rec, {\r\n            expirationTtl: null,\r\n            metadata: {\r\n                userId: String(userId),\r\n                threadId: res.result.message_thread_id\r\n            }\r\n        });\r\n\r\n        if (userId) {\r\n            await env.TOPIC_MAP.put(`thread:${rec.thread_id}`, String(userId));\r\n        }\r\n    }\r\n    return rec;\r\n}\r\n\r\nexport async function updateThreadStatusImpl({\r\n    threadId,\r\n    isClosed,\r\n    env,\r\n    hasD1,\r\n    dbThreadGetUserId,\r\n    dbUserGet,\r\n    dbUserUpdate,\r\n    dbThreadDelete,\r\n    safeGetJSON,\r\n    getAllKeys,\r\n    Logger\r\n}) {\r\n    try {\r\n        if (hasD1(env)) {\r\n            const mappedUser = await dbThreadGetUserId(env, threadId);\r\n            if (mappedUser) {\r\n                const rec = await dbUserGet(env, mappedUser);\r\n                if (rec && Number(rec.thread_id) === Number(threadId)) {\r\n                    await dbUserUpdate(env, mappedUser, { closed: isClosed });\r\n                    Logger.info('thread_status_updated', { threadId, isClosed, updatedCount: 1 });\r\n                    return;\r\n                }\r\n                await dbThreadDelete(env, threadId);\r\n            }\r\n\r\n            const result = await env.TG_BOT_DB\r\n                .prepare('SELECT user_id FROM users WHERE thread_id = ?')\r\n                .bind(String(threadId))\r\n                .all();\r\n\r\n            const rows = result?.results || [];\r\n            for (const row of rows) {\r\n                await dbUserUpdate(env, row.user_id, { closed: isClosed });\r\n            }\r\n            Logger.info('thread_status_updated', { threadId, isClosed, updatedCount: rows.length });\r\n            return;\r\n        }\r\n\r\n        const mappedUser = await env.TOPIC_MAP.get(`thread:${threadId}`);\r\n        if (mappedUser) {\r\n            const userKey = `user:${mappedUser}`;\r\n            const rec = await safeGetJSON(env, userKey, null);\r\n            if (rec && Number(rec.thread_id) === Number(threadId)) {\r\n                rec.closed = isClosed;\r\n                await env.TOPIC_MAP.put(userKey, JSON.stringify(rec));\r\n                Logger.info('thread_status_updated', { threadId, isClosed, updatedCount: 1 });\r\n                return;\r\n            }\r\n            await env.TOPIC_MAP.delete(`thread:${threadId}`);\r\n        }\r\n\r\n        const allKeys = await getAllKeys(env, 'user:');\r\n        const updates = [];\r\n\r\n        for (const { name } of allKeys) {\r\n            const rec = await safeGetJSON(env, name, null);\r\n            if (rec && Number(rec.thread_id) === Number(threadId)) {\r\n                rec.closed = isClosed;\r\n                updates.push(env.TOPIC_MAP.put(name, JSON.stringify(rec)));\r\n            }\r\n        }\r\n\r\n        await Promise.all(updates);\r\n        Logger.info('thread_status_updated', { threadId, isClosed, updatedCount: updates.length });\r\n    } catch (e) {\r\n        Logger.error('thread_status_update_failed', e, { threadId, isClosed });\r\n        throw e;\r\n    }\r\n}\r\n", "export async function handleEditedMessageImpl({\r\n    msg,\r\n    env,\r\n    hasD1,\r\n    dbMessageMapGet,\r\n    safeGetJSON,\r\n    dbUserGet,\r\n    tgCall,\r\n    Logger\r\n}) {\r\n    if (msg.chat?.id == env.SUPERGROUP_ID) {\r\n        const sourceChatId = msg.chat.id;\r\n        const sourceMsgId = msg.message_id;\r\n\r\n        const targetInfo = hasD1(env)\r\n            ? await dbMessageMapGet(env, sourceChatId, sourceMsgId)\r\n            : await safeGetJSON(env, `msg_map:${String(sourceChatId)}:${sourceMsgId}`, null);\r\n\r\n        if (targetInfo) {\r\n            const { targetChatId, targetMsgId } = targetInfo;\r\n\r\n            try {\r\n                if (msg.text) {\r\n                    await tgCall(env, 'editMessageText', {\r\n                        chat_id: targetChatId,\r\n                        message_id: targetMsgId,\r\n                        text: msg.text,\r\n                        entities: msg.entities,\r\n                        parse_mode: msg.parse_mode\r\n                    });\r\n                } else if (msg.caption) {\r\n                    await tgCall(env, 'editMessageCaption', {\r\n                        chat_id: targetChatId,\r\n                        message_id: targetMsgId,\r\n                        caption: msg.caption,\r\n                        caption_entities: msg.caption_entities,\r\n                        parse_mode: msg.parse_mode\r\n                    });\r\n                }\r\n            } catch (error) {\r\n                Logger.warn('edit_message_forward_failed', {\r\n                    sourceChatId,\r\n                    sourceMsgId,\r\n                    targetChatId,\r\n                    targetMsgId,\r\n                    error: error.message\r\n                });\r\n            }\r\n        }\r\n    } else {\r\n        const userId = msg.chat.id;\r\n        const sourceMsgId = msg.message_id;\r\n\r\n        const userRec = hasD1(env)\r\n            ? await dbUserGet(env, userId)\r\n            : await safeGetJSON(env, `user:${userId}`, null);\r\n\r\n        if (!userRec || !userRec.thread_id) {\r\n            return;\r\n        }\r\n\r\n        const targetInfo = hasD1(env)\r\n            ? await dbMessageMapGet(env, userId, sourceMsgId)\r\n            : await safeGetJSON(env, `msg_map:${String(userId)}:${sourceMsgId}`, null);\r\n\r\n        if (targetInfo) {\r\n            const { targetChatId, targetMsgId } = targetInfo;\r\n\r\n            try {\r\n                if (msg.text) {\r\n                    await tgCall(env, 'editMessageText', {\r\n                        chat_id: env.SUPERGROUP_ID,\r\n                        message_id: targetMsgId,\r\n                        message_thread_id: userRec.thread_id,\r\n                        text: msg.text,\r\n                        entities: msg.entities,\r\n                        parse_mode: msg.parse_mode\r\n                    });\r\n                } else if (msg.caption) {\r\n                    await tgCall(env, 'editMessageCaption', {\r\n                        chat_id: env.SUPERGROUP_ID,\r\n                        message_id: targetMsgId,\r\n                        message_thread_id: userRec.thread_id,\r\n                        caption: msg.caption,\r\n                        caption_entities: msg.caption_entities,\r\n                        parse_mode: msg.parse_mode\r\n                    });\r\n                }\r\n            } catch (error) {\r\n                Logger.warn('edit_message_forward_failed', {\r\n                    sourceChatId: userId,\r\n                    sourceMsgId,\r\n                    targetChatId,\r\n                    targetMsgId,\r\n                    error: error.message\r\n                });\r\n            }\r\n        }\r\n    }\r\n}\r\n", "export async function handleAdminReplyImpl(msg, env, ctx, deps) {\r\n    const { isAdminUser, hasD1, dbKeywordListWithId, tgCall, dbSetBanned, dbThreadGetUserId, dbThreadPut, getAllKeys, safeGetJSON, dbKeywordAdd, dbKeywordDelete, dbKeywordDeleteById, validateKeywordPattern, CONFIG, dbUserUpdate, dbSetVerifyState, dbUserGet, dbGetVerifyState, dbIsBanned, handleMediaGroup, dbMessageMapPut, handleCleanupCommand } = deps;\r\n\r\n    const threadId = msg.message_thread_id;\r\n    const text = (msg.text || \"\").trim();\r\n    const senderId = msg.from?.id;\r\n    const parts = text.split(/\\s+/).filter(Boolean);\r\n    const baseCmd = parts[0] || \"\";\r\n\r\n    // \u6743\u9650\u68C0\u67E5\r\n    if (!senderId || !(await isAdminUser(env, senderId))) {\r\n        return;\r\n    }\r\n\r\n    // /cleanup \u547D\u4EE4\u5904\u7406\r\n    if (text === \"/cleanup\") {\r\n        ctx.waitUntil(handleCleanupCommand(threadId, env));\r\n        return;\r\n    }\r\n\r\n    // /help \u547D\u4EE4\u5904\u7406\r\n    if (text === \"/help\") {\r\n        const helpText = [\r\n            \"\uD83D\uDEE0\uFE0F **\u7BA1\u7406\u5458\u6307\u4EE4**\",\r\n            \"\",\r\n            \"/info - \u663E\u793A\u5F53\u524D\u7528\u6237\u4FE1\u606F\",\r\n            \"/close - \u5173\u95ED\u5BF9\u8BDD\",\r\n            \"/open - \u91CD\u65B0\u5F00\u542F\u5BF9\u8BDD\",\r\n            \"/ban - \u5C01\u7981\u7528\u6237\",\r\n            \"/unban - \u89E3\u5C01\u7528\u6237\",\r\n            \"/trust - \u8BBE\u4E3A\u6C38\u4E45\u4FE1\u4EFB\",\r\n            \"/reset - \u91CD\u7F6E\u9A8C\u8BC1\u72B6\u6001\",\r\n            \"/cleanup - \u6E05\u7406\u5DF2\u5220\u9664\u8BDD\u9898\u6570\u636E\",\r\n            \"/kw help - \u5173\u952E\u8BCD\u7BA1\u7406\u5E2E\u52A9\"\r\n        ].join(\"\\n\");\r\n        await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: helpText, parse_mode: \"Markdown\" });\r\n        return;\r\n    }\r\n\r\n    // \u5141\u8BB8\u4EFB\u610F\u8BDD\u9898\u6267\u884C\u7684\u7BA1\u7406\u6307\u4EE4\r\n    if (baseCmd === \"/kw\" && parts[1] === \"list\") {\r\n        if (!hasD1(env)) {\r\n            const warnText = \"\u26A0\uFE0F \u5173\u952E\u8BCD\u529F\u80FD\u9700\u8981\u7ED1\u5B9A D1 \u6570\u636E\u5E93\u3002\";\r\n            const payload = { chat_id: env.SUPERGROUP_ID, text: warnText, parse_mode: \"Markdown\" };\r\n            if (threadId) payload.message_thread_id = threadId;\r\n            await tgCall(env, \"sendMessage\", payload);\r\n            return;\r\n        }\r\n\r\n        const list = await dbKeywordListWithId(env);\r\n        if (!list.length) {\r\n            const payload = { chat_id: env.SUPERGROUP_ID, text: \"\u5F53\u524D\u6682\u65E0\u5173\u952E\u8BCD\u3002\" };\r\n            if (threadId) payload.message_thread_id = threadId;\r\n            await tgCall(env, \"sendMessage\", payload);\r\n            return;\r\n        }\r\n\r\n        const items = list.slice(0, 50).map((k, i) => `${i + 1}. [id=${k.id}] ${k.keyword}`);\r\n        const header = \"\uD83D\uDCCC \u5173\u952E\u8BCD\u5217\u8868\";\r\n        const maxLen = 3800;\r\n        let buffer = `${header}\\n\\n`;\r\n        for (const line of items) {\r\n            if ((buffer.length + line.length + 1) > maxLen) {\r\n                const payload = { chat_id: env.SUPERGROUP_ID, text: buffer.trimEnd() };\r\n                if (threadId) payload.message_thread_id = threadId;\r\n                await tgCall(env, \"sendMessage\", payload);\r\n                buffer = \"\";\r\n            }\r\n            buffer += (buffer ? \"\\n\" : \"\") + line;\r\n        }\r\n        if (buffer.trim()) {\r\n            const payload = { chat_id: env.SUPERGROUP_ID, text: buffer.trimEnd() };\r\n            if (threadId) payload.message_thread_id = threadId;\r\n            await tgCall(env, \"sendMessage\", payload);\r\n        }\r\n        return;\r\n    }\r\n\r\n    if (baseCmd === \"/ban\" && parts[1] && /^\\d+$/.test(parts[1])) {\r\n        const targetUserId = Number(parts[1]);\r\n        if (hasD1(env)) {\r\n            await dbSetBanned(env, targetUserId, true);\r\n        } else {\r\n            await env.TOPIC_MAP.put(`banned:${targetUserId}`, \"1\");\r\n        }\r\n        const payload = {\r\n            chat_id: env.SUPERGROUP_ID,\r\n            text: `\uD83D\uDEAB **\u7528\u6237\u5DF2\u5C01\u7981**\\nUID: \\`${targetUserId}\\``,\r\n            parse_mode: \"Markdown\"\r\n        };\r\n        if (threadId) payload.message_thread_id = threadId;\r\n        await tgCall(env, \"sendMessage\", payload);\r\n        return;\r\n    }\r\n\r\n    if (baseCmd === \"/unban\" && parts[1] && /^\\d+$/.test(parts[1])) {\r\n        const targetUserId = Number(parts[1]);\r\n        if (hasD1(env)) {\r\n            await dbSetBanned(env, targetUserId, false);\r\n        } else {\r\n            await env.TOPIC_MAP.delete(`banned:${targetUserId}`);\r\n        }\r\n        const payload = {\r\n            chat_id: env.SUPERGROUP_ID,\r\n            text: `\u2705 **\u7528\u6237\u5DF2\u89E3\u5C01**\\nUID: \\`${targetUserId}\\``,\r\n            parse_mode: \"Markdown\"\r\n        };\r\n        if (threadId) payload.message_thread_id = threadId;\r\n        await tgCall(env, \"sendMessage\", payload);\r\n        return;\r\n    }\r\n\r\n    // \u67E5\u627E\u7528\u6237 ID\r\n    let userId = null;\r\n    if (hasD1(env)) {\r\n        const mappedUser = await dbThreadGetUserId(env, threadId);\r\n        if (mappedUser) {\r\n            userId = Number(mappedUser);\r\n        } else {\r\n            const result = await env.TG_BOT_DB\r\n                .prepare(\"SELECT user_id FROM users WHERE thread_id = ?\")\r\n                .bind(String(threadId))\r\n                .first();\r\n            if (result?.user_id) {\r\n                userId = Number(result.user_id);\r\n                await dbThreadPut(env, threadId, userId);\r\n            }\r\n        }\r\n    } else {\r\n        const mappedUser = await env.TOPIC_MAP.get(`thread:${threadId}`);\r\n        if (mappedUser) {\r\n            userId = Number(mappedUser);\r\n        } else {\r\n            const allKeys = await getAllKeys(env, \"user:\");\r\n            for (const { name } of allKeys) {\r\n                const rec = await safeGetJSON(env, name, null);\r\n                if (rec && Number(rec.thread_id) === Number(threadId)) {\r\n                    userId = Number(name.slice(5));\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    if (!userId) return;\r\n\r\n    // \u7BA1\u7406\u5458\u547D\u4EE4\u5904\u7406\r\n    if (text.startsWith(\"/kw\")) {\r\n        if (!hasD1(env)) {\r\n            await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\u26A0\uFE0F \u5173\u952E\u8BCD\u529F\u80FD\u9700\u8981\u7ED1\u5B9A D1 \u6570\u636E\u5E93\u3002\", parse_mode: \"Markdown\" });\r\n            return;\r\n        }\r\n\r\n        const parts = text.split(\" \").filter(Boolean);\r\n        const action = parts[1] || \"help\";\r\n        const subAction = parts[2] || \"\";\r\n        const restText = parts.slice(2).join(\" \").trim();\r\n\r\n        if (action === \"add\") {\r\n            if (!restText) {\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\u7528\u6CD5\uFF1A`/kw add \u5173\u952E\u8BCD`\", parse_mode: \"Markdown\" });\r\n                return;\r\n            }\r\n            const validation = validateKeywordPattern(restText);\r\n            if (!validation.ok) {\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: `\u274C \u5173\u952E\u8BCD\u89C4\u5219\u88AB\u62D2\u7EDD\uFF1A${validation.reason}`, parse_mode: \"Markdown\" });\r\n                return;\r\n            }\r\n            await dbKeywordAdd(env, restText);\r\n            await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: `\u2705 \u5DF2\u6DFB\u52A0\u5173\u952E\u8BCD\uFF1A\\`${restText}\\``, parse_mode: \"Markdown\" });\r\n            return;\r\n        }\r\n\r\n        if (action === \"del\") {\r\n            if (!restText) {\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\u7528\u6CD5\uFF1A`/kw del \u5173\u952E\u8BCD` \u6216 `/kw del id <id>`\", parse_mode: \"Markdown\" });\r\n                return;\r\n            }\r\n            if (subAction === \"id\") {\r\n                const idText = parts[3];\r\n                if (!idText || !/^\\d+$/.test(idText)) {\r\n                    await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\u7528\u6CD5\uFF1A`/kw del id <id>`\", parse_mode: \"Markdown\" });\r\n                    return;\r\n                }\r\n                const changes = await dbKeywordDeleteById(env, Number(idText));\r\n                if (changes > 0) {\r\n                    await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: `\u2705 \u5DF2\u5220\u9664\u5173\u952E\u8BCD\uFF08ID\uFF09\uFF1A\\`${idText}\\``, parse_mode: \"Markdown\" });\r\n                } else {\r\n                    await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: `\u274C \u672A\u627E\u5230\u5173\u952E\u8BCD\uFF08ID\uFF09\uFF1A\\`${idText}\\``, parse_mode: \"Markdown\" });\r\n                }\r\n                return;\r\n            }\r\n            const changes = await dbKeywordDelete(env, restText);\r\n            if (changes > 0) {\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: `\u2705 \u5DF2\u5220\u9664\u5173\u952E\u8BCD\uFF1A\\`${restText}\\``, parse_mode: \"Markdown\" });\r\n            } else {\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: `\u274C \u672A\u627E\u5230\u5173\u952E\u8BCD\uFF1A\\`${restText}\\``, parse_mode: \"Markdown\" });\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (action === \"list\") {\r\n            const list = await dbKeywordListWithId(env);\r\n            if (!list.length) {\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\u5F53\u524D\u6682\u65E0\u5173\u952E\u8BCD\u3002\" });\r\n                return;\r\n            }\r\n            const items = list.slice(0, 50).map((k, i) => `${i + 1}. [id=${k.id}] ${k.keyword}`);\r\n            const header = \"\uD83D\uDCCC \u5173\u952E\u8BCD\u5217\u8868\";\r\n            const maxLen = 3800;\r\n            let buffer = `${header}\\n\\n`;\r\n            for (const line of items) {\r\n                if ((buffer.length + line.length + 1) > maxLen) {\r\n                    await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: buffer.trimEnd() });\r\n                    buffer = \"\";\r\n                }\r\n                buffer += (buffer ? \"\\n\" : \"\") + line;\r\n            }\r\n            if (buffer.trim()) {\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: buffer.trimEnd() });\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (action === \"test\") {\r\n            const rest = text.replace(/^\\/kw\\s+test\\s+/i, \"\");\r\n            const [pattern, ...textParts] = rest.split(\" \");\r\n            const sample = textParts.join(\" \").trim();\r\n            if (!pattern || !sample) {\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\u7528\u6CD5\uFF1A`/kw test <\u8868\u8FBE\u5F0F> <\u6587\u672C>`\", parse_mode: \"Markdown\" });\r\n                return;\r\n            }\r\n            const validation = validateKeywordPattern(pattern);\r\n            if (!validation.ok) {\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: `\u274C \u5173\u952E\u8BCD\u89C4\u5219\u88AB\u62D2\u7EDD\uFF1A${validation.reason}`, parse_mode: \"Markdown\" });\r\n                return;\r\n            }\r\n            try {\r\n                const re = new RegExp(pattern, \"i\");\r\n                const matched = re.test(sample);\r\n                const resultText = matched ? \"\u2705 \u5339\u914D\u6210\u529F\" : \"\u274C \u672A\u547D\u4E2D\";\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: `${resultText}\\n\u8868\u8FBE\u5F0F\uFF1A\\`${pattern}\\`\\n\u6587\u672C\uFF1A\\`${sample}\\``, parse_mode: \"Markdown\" });\r\n            } catch (e) {\r\n                await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: `\u274C \u6B63\u5219\u8BED\u6CD5\u9519\u8BEF\uFF1A\\`${e.message}\\``, parse_mode: \"Markdown\" });\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (action === \"help\") {\r\n            const helpText = [\r\n                \"\uD83D\uDD0E **\u5173\u952E\u8BCD\u7BA1\u7406**\",\r\n                \"\",\r\n                \"/kw add \u5173\u952E\u8BCD - \u6DFB\u52A0\u5173\u952E\u8BCD\",\r\n                \"/kw del \u5173\u952E\u8BCD - \u5220\u9664\u5173\u952E\u8BCD\",\r\n                \"/kw del id <id> - \u6309 ID \u5220\u9664\u5173\u952E\u8BCD\",\r\n                \"/kw list - \u67E5\u770B\u5173\u952E\u8BCD\u5217\u8868\",\r\n                \"/kw test <\u8868\u8FBE\u5F0F> <\u6587\u672C> - \u6D4B\u8BD5\u6B63\u5219\u662F\u5426\u547D\u4E2D\",\r\n                \"\",\r\n                \"\u89C4\u5219\u9650\u5236\uFF1A\",\r\n                `1) \u5173\u952E\u8BCD\u957F\u5EA6\u4E0A\u9650 ${CONFIG.KEYWORD_MAX_LENGTH} \u5B57\u7B26`,\r\n                `2) \u8FC7\u6EE4\u4EC5\u5339\u914D\u524D ${CONFIG.KEYWORD_MATCH_MAX_TEXT_LENGTH} \u5B57\u7B26`,\r\n                \"3) \u6B63\u5219\u9650\u5236\uFF1A\",\r\n                \"- `.*` / `.+` \u51FA\u73B0\u8D85\u8FC7 2 \u6B21\u4F1A\u88AB\u62D2\u7EDD\",\r\n                \"- \u5D4C\u5957\u91CF\u8BCD\u4F1A\u88AB\u62D2\u7EDD\uFF08\u5982 `(a+)+`\u3001`(.+)+`\u3001`(.+)*`\u3001`(.*)+`\uFF09\",\r\n                \"- \u5F62\u5982 `(.*){2,}`\u3001`(.+){1,}` \u7684\u91CD\u590D\u7ED3\u6784\u4F1A\u88AB\u62D2\u7EDD\"\r\n            ].join(\"\\n\");\r\n            await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: helpText, parse_mode: \"Markdown\" });\r\n            return;\r\n        }\r\n\r\n        await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\u7528\u6CD5\uFF1A`/kw add \u5173\u952E\u8BCD` / `/kw del \u5173\u952E\u8BCD` / `/kw del id <id>` / `/kw list` / `/kw test <\u8868\u8FBE\u5F0F> <\u6587\u672C>` / `/kw help`\", parse_mode: \"Markdown\" });\r\n        return;\r\n    }\r\n\r\n    if (text === \"/close\") {\r\n        if (hasD1(env)) {\r\n            await dbUserUpdate(env, userId, { closed: true });\r\n        } else {\r\n            const key = `user:${userId}`;\r\n            let rec = await safeGetJSON(env, key, null);\r\n            if (rec) {\r\n                rec.closed = true;\r\n                await env.TOPIC_MAP.put(key, JSON.stringify(rec));\r\n            }\r\n        }\r\n        await tgCall(env, \"closeForumTopic\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId });\r\n        await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\uD83D\uDEAB **\u5BF9\u8BDD\u5DF2\u5F3A\u5236\u5173\u95ED**\", parse_mode: \"Markdown\" });\r\n        return;\r\n    }\r\n\r\n    if (text === \"/open\") {\r\n        if (hasD1(env)) {\r\n            await dbUserUpdate(env, userId, { closed: false });\r\n        } else {\r\n            const key = `user:${userId}`;\r\n            let rec = await safeGetJSON(env, key, null);\r\n            if (rec) {\r\n                rec.closed = false;\r\n                await env.TOPIC_MAP.put(key, JSON.stringify(rec));\r\n            }\r\n        }\r\n        await tgCall(env, \"reopenForumTopic\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId });\r\n        await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\u2705 **\u5BF9\u8BDD\u5DF2\u6062\u590D**\", parse_mode: \"Markdown\" });\r\n        return;\r\n    }\r\n\r\n    if (text === \"/reset\") {\r\n        if (hasD1(env)) {\r\n            await dbSetVerifyState(env, userId, null);\r\n        } else {\r\n            await env.TOPIC_MAP.delete(`verified:${userId}`);\r\n        }\r\n        await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\uD83D\uDD04 **\u9A8C\u8BC1\u91CD\u7F6E**\", parse_mode: \"Markdown\" });\r\n        return;\r\n    }\r\n\r\n    if (text === \"/trust\") {\r\n        if (hasD1(env)) {\r\n            await dbSetVerifyState(env, userId, \"trusted\");\r\n        } else {\r\n            await env.TOPIC_MAP.put(`verified:${userId}`, \"trusted\");\r\n        }\r\n        await env.TOPIC_MAP.delete(`needs_verify:${userId}`);\r\n        await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\uD83C\uDF1F **\u5DF2\u8BBE\u7F6E\u6C38\u4E45\u4FE1\u4EFB**\", parse_mode: \"Markdown\" });\r\n        return;\r\n    }\r\n\r\n    if (text === \"/ban\") {\r\n        if (hasD1(env)) {\r\n            await dbSetBanned(env, userId, true);\r\n        } else {\r\n            await env.TOPIC_MAP.put(`banned:${userId}`, \"1\");\r\n        }\r\n        await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\uD83D\uDEAB **\u7528\u6237\u5DF2\u5C01\u7981**\", parse_mode: \"Markdown\" });\r\n        return;\r\n    }\r\n\r\n    if (text === \"/unban\") {\r\n        if (hasD1(env)) {\r\n            await dbSetBanned(env, userId, false);\r\n        } else {\r\n            await env.TOPIC_MAP.delete(`banned:${userId}`);\r\n        }\r\n        await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: \"\u2705 **\u7528\u6237\u5DF2\u89E3\u5C01**\", parse_mode: \"Markdown\" });\r\n        return;\r\n    }\r\n\r\n    if (text === \"/info\") {\r\n        const userRec = hasD1(env)\r\n            ? await dbUserGet(env, userId)\r\n            : await safeGetJSON(env, `user:${userId}`, null);\r\n        const verifyStatus = hasD1(env)\r\n            ? await dbGetVerifyState(env, userId)\r\n            : await env.TOPIC_MAP.get(`verified:${userId}`);\r\n        const banStatus = hasD1(env)\r\n            ? await dbIsBanned(env, userId)\r\n            : await env.TOPIC_MAP.get(`banned:${userId}`);\r\n\r\n        const info = `\uD83D\uDC64 **\u7528\u6237\u4FE1\u606F**\\nUID: \\`${userId}\\`\\nTopic ID: \\`${threadId}\\`\\n\u8BDD\u9898\u6807\u9898: ${userRec?.title || \"\u672A\u77E5\"}\\n\u9A8C\u8BC1\u72B6\u6001: ${verifyStatus ? (verifyStatus === 'trusted' ? '\uD83C\uDF1F \u6C38\u4E45\u4FE1\u4EFB' : '\u2705 \u5DF2\u9A8C\u8BC1') : '\u274C \u672A\u9A8C\u8BC1'}\\n\u5C01\u7981\u72B6\u6001: ${banStatus ? '\uD83D\uDEAB \u5DF2\u5C01\u7981' : '\u2705 \u6B63\u5E38'}\\nLink: [\u70B9\u51FB\u79C1\u804A](tg://user?id=${userId})`;\r\n        await tgCall(env, \"sendMessage\", { chat_id: env.SUPERGROUP_ID, message_thread_id: threadId, text: info, parse_mode: \"Markdown\" });\r\n        return;\r\n    }\r\n\r\n    // \u8F6C\u53D1\u7BA1\u7406\u5458\u6D88\u606F\u7ED9\u7528\u6237\r\n    if (msg.media_group_id) {\r\n        await handleMediaGroup(msg, env, ctx, { direction: \"t2p\", targetChat: userId, threadId: undefined });\r\n        return;\r\n    }\r\n\r\n    const copyResult = await tgCall(env, \"copyMessage\", {\r\n        chat_id: userId,\r\n        from_chat_id: env.SUPERGROUP_ID,\r\n        message_id: msg.message_id\r\n    });\r\n\r\n    if (copyResult.ok) {\r\n        if (hasD1(env)) {\r\n            await dbMessageMapPut(env, env.SUPERGROUP_ID, msg.message_id, userId, copyResult.result.message_id);\r\n        } else {\r\n            const mapKey = `msg_map:${String(env.SUPERGROUP_ID)}:${msg.message_id}`;\r\n            const mapValue = JSON.stringify({\r\n                targetChatId: String(userId),\r\n                targetMsgId: copyResult.result.message_id,\r\n                createdAt: Date.now()\r\n            });\r\n            await env.TOPIC_MAP.put(mapKey, mapValue, {\r\n                expirationTtl: CONFIG.MESSAGE_MAP_TTL_SECONDS\r\n            });\r\n        }\r\n    }\r\n}\r\n", "export async function handlePrivateMessageImpl(msg, env, ctx, deps) {\r\n    const { forwardToTopic } = deps;\r\n    await forwardToTopic(msg, env, ctx);\r\n}\r\n\r\nexport async function forwardToTopicImpl(msg, env, ctx, deps) {\r\n    const {\r\n        checkRateLimit,\r\n        CONFIG,\r\n        tgCall,\r\n        hasD1,\r\n        dbIsBanned,\r\n        dbGetVerifyState,\r\n        sendVerificationChallenge,\r\n        getFilterText,\r\n        matchKeyword,\r\n        Logger,\r\n        dbUserGet,\r\n        safeGetJSON,\r\n        getOrCreateUserTopicRec,\r\n        sendWelcomeCard,\r\n        dbThreadGetUserId,\r\n        dbThreadPut,\r\n        threadHealthCache,\r\n        probeForumThread,\r\n        resetUserVerificationAndRequireReverify,\r\n        handleMediaGroup,\r\n        normalizeTgDescription,\r\n        isTopicMissingOrDeleted,\r\n        dbMessageMapPut\r\n    } = deps;\r\n\r\n    const userId = msg.chat.id;\r\n    const key = `user:${userId}`;\r\n\r\n    // \u901F\u7387\u9650\u5236\u68C0\u67E5\r\n    const rateLimit = await checkRateLimit(userId, env, 'message', CONFIG.RATE_LIMIT_MESSAGE, CONFIG.RATE_LIMIT_WINDOW);\r\n    if (!rateLimit.allowed) {\r\n        await tgCall(env, \"sendMessage\", {\r\n            chat_id: userId,\r\n            text: \"\u26A0\uFE0F \u53D1\u9001\u8FC7\u4E8E\u9891\u7E41\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002\"\r\n        });\r\n        return;\r\n    }\r\n\r\n    // \u62E6\u622A\u666E\u901A\u7528\u6237\u547D\u4EE4\r\n    if (msg.text && msg.text.startsWith(\"/\") && msg.text.trim() !== \"/start\") {\r\n        return;\r\n    }\r\n\r\n    // \u68C0\u67E5\u5C01\u7981\r\n    const isBanned = hasD1(env)\r\n        ? await dbIsBanned(env, userId)\r\n        : await env.TOPIC_MAP.get(`banned:${userId}`);\r\n    if (isBanned) return;\r\n\r\n    // \u68C0\u67E5\u9A8C\u8BC1\u72B6\u6001\r\n    const verified = hasD1(env)\r\n        ? await dbGetVerifyState(env, userId)\r\n        : await env.TOPIC_MAP.get(`verified:${userId}`);\r\n    if (!verified) {\r\n        const isStart = msg.text && msg.text.trim() === \"/start\";\r\n        const pendingMsgId = isStart ? null : msg.message_id;\r\n        await sendVerificationChallenge(userId, env, pendingMsgId);\r\n        return;\r\n    }\r\n\r\n    // \u68C0\u67E5\u662F\u5426\u9700\u8981\u91CD\u65B0\u9A8C\u8BC1\r\n    const needsVerify = await env.TOPIC_MAP.get(`needs_verify:${userId}`);\r\n    if (needsVerify) {\r\n        await sendVerificationChallenge(userId, env, msg.message_id || null);\r\n        return;\r\n    }\r\n\r\n    // \u5173\u952E\u8BCD\u8FC7\u6EE4\r\n    const filterText = getFilterText(msg);\r\n    if (filterText) {\r\n        const hitKeyword = await matchKeyword(env, filterText);\r\n        if (hitKeyword) {\r\n            await tgCall(env, \"sendMessage\", {\r\n                chat_id: userId,\r\n                text: \"\u26A0\uFE0F \u8BE5\u6D88\u606F\u89E6\u53D1\u8FC7\u6EE4\u6761\u4EF6\uFF0C\u5DF2\u88AB\u62E6\u622A\u3002\"\r\n            });\r\n            Logger.info('keyword_blocked', { userId, keyword: hitKeyword });\r\n            return;\r\n        }\r\n    }\r\n\r\n    // \u83B7\u53D6\u7528\u6237\u8BDD\u9898\u8BB0\u5F55\r\n    let rec = hasD1(env)\r\n        ? await dbUserGet(env, userId)\r\n        : await safeGetJSON(env, key, null);\r\n\r\n    if (rec && rec.closed) {\r\n        await tgCall(env, \"sendMessage\", { chat_id: userId, text: \"\uD83D\uDEAB \u5F53\u524D\u5BF9\u8BDD\u5DF2\u88AB\u7BA1\u7406\u5458\u5173\u95ED\u3002\" });\r\n        return;\r\n    }\r\n\r\n    // \u91CD\u8BD5\u8BA1\u6570\u5668\r\n    const retryKey = `retry:${userId}`;\r\n    let retryCount = parseInt(await env.TOPIC_MAP.get(retryKey) || \"0\");\r\n\r\n    if (retryCount > CONFIG.MAX_RETRY_ATTEMPTS) {\r\n        await tgCall(env, \"sendMessage\", {\r\n            chat_id: userId,\r\n            text: \"\u274C \u7CFB\u7EDF\u7E41\u5FD9\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002\"\r\n        });\r\n        await env.TOPIC_MAP.delete(retryKey);\r\n        return;\r\n    }\r\n\r\n    if (!rec || !rec.thread_id) {\r\n        rec = await getOrCreateUserTopicRec(msg.from, key, env, userId);\r\n        if (!rec || !rec.thread_id) {\r\n            throw new Error(\"\u521B\u5EFA\u8BDD\u9898\u5931\u8D25\");\r\n        }\r\n\r\n        // \u65B0\u7528\u6237\u63A5\u5165\uFF1A\u53D1\u9001\u7528\u6237\u4FE1\u606F\u5361\u7247\r\n        await sendWelcomeCard(env, rec.thread_id, userId, msg.from);\r\n    }\r\n\r\n    // \u8865\u5EFA thread->user \u6620\u5C04\uFF08\u517C\u5BB9\u65E7\u6570\u636E\uFF09\r\n    if (rec && rec.thread_id) {\r\n        if (hasD1(env)) {\r\n            const mappedUser = await dbThreadGetUserId(env, rec.thread_id);\r\n            if (!mappedUser) {\r\n                await dbThreadPut(env, rec.thread_id, userId);\r\n            }\r\n        } else {\r\n            const mappedUser = await env.TOPIC_MAP.get(`thread:${rec.thread_id}`);\r\n            if (!mappedUser) {\r\n                await env.TOPIC_MAP.put(`thread:${rec.thread_id}`, String(userId));\r\n            }\r\n        }\r\n    }\r\n\r\n    // \u9A8C\u8BC1\u8BDD\u9898\u5065\u5EB7\u72B6\u6001\r\n    if (rec && rec.thread_id) {\r\n        const cacheKey = rec.thread_id;\r\n        const now = Date.now();\r\n        const cached = threadHealthCache.get(cacheKey);\r\n        const withinTTL = cached && (now - cached.ts < CONFIG.THREAD_HEALTH_TTL_MS);\r\n\r\n        if (!withinTTL) {\r\n            const kvHealthKey = `thread_ok:${rec.thread_id}`;\r\n            const kvHealthOk = await env.TOPIC_MAP.get(kvHealthKey);\r\n            if (kvHealthOk === \"1\") {\r\n                threadHealthCache.set(cacheKey, { ts: now, ok: true });\r\n            } else {\r\n                const probe = await probeForumThread(env, rec.thread_id, { userId, reason: \"health_check\" });\r\n\r\n                if (probe.status === \"redirected\" || probe.status === \"missing\" || probe.status === \"missing_thread_id\") {\r\n                    await resetUserVerificationAndRequireReverify(env, {\r\n                        userId,\r\n                        userKey: key,\r\n                        oldThreadId: rec.thread_id,\r\n                        pendingMsgId: msg.message_id,\r\n                        reason: `health_check:${probe.status}`,\r\n                        userFrom: msg.from\r\n                    });\r\n                    return;\r\n                } else if (probe.status === \"probe_invalid\") {\r\n                    Logger.warn('topic_health_probe_invalid_message', {\r\n                        userId,\r\n                        threadId: rec.thread_id,\r\n                        errorDescription: probe.description\r\n                    });\r\n                    threadHealthCache.set(cacheKey, { ts: now, ok: true });\r\n                    await env.TOPIC_MAP.put(kvHealthKey, \"1\", { expirationTtl: Math.ceil(CONFIG.THREAD_HEALTH_TTL_MS / 1000) });\r\n                } else if (probe.status === \"unknown_error\") {\r\n                    Logger.warn('topic_test_failed_unknown', {\r\n                        userId,\r\n                        threadId: rec.thread_id,\r\n                        errorDescription: probe.description\r\n                    });\r\n                } else {\r\n                    await env.TOPIC_MAP.delete(retryKey);\r\n                    threadHealthCache.set(cacheKey, { ts: now, ok: true });\r\n                    await env.TOPIC_MAP.put(kvHealthKey, \"1\", { expirationTtl: Math.ceil(CONFIG.THREAD_HEALTH_TTL_MS / 1000) });\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // \u5904\u7406\u5A92\u4F53\u7EC4\r\n    if (msg.media_group_id) {\r\n        await handleMediaGroup(msg, env, ctx, {\r\n            direction: \"p2t\",\r\n            targetChat: env.SUPERGROUP_ID,\r\n            threadId: rec.thread_id\r\n        });\r\n        return;\r\n    }\r\n\r\n    // \u8F6C\u53D1\u6D88\u606F\r\n    const copyResult = await tgCall(env, \"copyMessage\", {\r\n        chat_id: env.SUPERGROUP_ID,\r\n        from_chat_id: userId,\r\n        message_id: msg.message_id,\r\n        message_thread_id: rec.thread_id,\r\n    });\r\n\r\n    // \u68C0\u6D4B\u9759\u9ED8\u91CD\u5B9A\u5411\u5230 General\r\n    const resThreadId = copyResult.result?.message_thread_id;\r\n    if (copyResult.ok && resThreadId !== undefined && resThreadId !== null && Number(resThreadId) !== Number(rec.thread_id)) {\r\n        Logger.warn('forward_redirected_to_general', {\r\n            userId,\r\n            expectedThreadId: rec.thread_id,\r\n            actualThreadId: resThreadId\r\n        });\r\n\r\n        if (copyResult.result?.message_id) {\r\n            try {\r\n                await tgCall(env, \"deleteMessage\", {\r\n                    chat_id: env.SUPERGROUP_ID,\r\n                    message_id: copyResult.result.message_id\r\n                });\r\n            } catch (e) {\r\n                // \u5FFD\u7565\u5220\u9664\u5931\u8D25\r\n            }\r\n        }\r\n        await resetUserVerificationAndRequireReverify(env, {\r\n            userId,\r\n            userKey: key,\r\n            oldThreadId: rec.thread_id,\r\n            pendingMsgId: msg.message_id,\r\n            reason: \"forward_redirected_to_general\",\r\n            userFrom: msg.from\r\n        });\r\n        return;\r\n    }\r\n\r\n    // \u515C\u5E95\uFF1A\u68C0\u67E5\u8FD4\u56DE\u7ED3\u679C\u662F\u5426\u7F3A\u5C11\u7EBF\u7A0BID\r\n    if (copyResult.ok && (resThreadId === undefined || resThreadId === null)) {\r\n        const probe = await probeForumThread(env, rec.thread_id, { userId, reason: \"forward_result_missing_thread_id\" });\r\n        if (probe.status !== \"ok\") {\r\n            Logger.warn('forward_suspected_redirect_or_missing', {\r\n                userId,\r\n                expectedThreadId: rec.thread_id,\r\n                probeStatus: probe.status,\r\n                probeDescription: probe.description\r\n            });\r\n\r\n            if (copyResult.result?.message_id) {\r\n                try {\r\n                    await tgCall(env, \"deleteMessage\", {\r\n                        chat_id: env.SUPERGROUP_ID,\r\n                        message_id: copyResult.result.message_id\r\n                    });\r\n                } catch (e) {\r\n                    // \u5FFD\u7565\u5220\u9664\u5931\u8D25\r\n                }\r\n            }\r\n            await resetUserVerificationAndRequireReverify(env, {\r\n                userId,\r\n                userKey: key,\r\n                oldThreadId: rec.thread_id,\r\n                pendingMsgId: msg.message_id,\r\n                reason: `forward_missing_thread_id:${probe.status}`,\r\n                userFrom: msg.from\r\n            });\r\n            return;\r\n        }\r\n    }\r\n\r\n    // \u989D\u5916\u68C0\u67E5\uFF1A\u8F6C\u53D1\u5931\u8D25\u60C5\u51B5\r\n    if (!copyResult.ok) {\r\n        const desc = normalizeTgDescription(copyResult.description);\r\n        if (isTopicMissingOrDeleted(desc)) {\r\n            Logger.warn('forward_failed_topic_missing', {\r\n                userId,\r\n                threadId: rec.thread_id,\r\n                errorDescription: copyResult.description\r\n            });\r\n            await resetUserVerificationAndRequireReverify(env, {\r\n                userId,\r\n                userKey: key,\r\n                oldThreadId: rec.thread_id,\r\n                pendingMsgId: msg.message_id,\r\n                reason: \"forward_failed_topic_missing\",\r\n                userFrom: msg.from\r\n            });\r\n            return;\r\n        }\r\n\r\n        if (desc.includes(\"chat not found\")) throw new Error(`\u7FA4\u7EC4ID\u9519\u8BEF: ${env.SUPERGROUP_ID}`);\r\n        if (desc.includes(\"not enough rights\")) throw new Error(\"\u673A\u5668\u4EBA\u6743\u9650\u4E0D\u8DB3 (\u9700 Manage Topics)\");\r\n\r\n        await tgCall(env, \"sendMessage\", {\r\n            chat_id: userId,\r\n            text: \"\u274C \u6D88\u606F\u53D1\u9001\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5\u3002\"\r\n        });\r\n        return;\r\n    }\r\n\r\n    // \u8BB0\u5F55\u6D88\u606F\u6620\u5C04\u5173\u7CFB\r\n    if (hasD1(env)) {\r\n        await dbMessageMapPut(env, userId, msg.message_id, env.SUPERGROUP_ID, copyResult.result.message_id);\r\n    } else {\r\n        const mapKey = `msg_map:${String(userId)}:${msg.message_id}`;\r\n        const mapValue = JSON.stringify({\r\n            targetChatId: String(env.SUPERGROUP_ID),\r\n            targetMsgId: copyResult.result.message_id,\r\n            createdAt: Date.now()\r\n        });\r\n        await env.TOPIC_MAP.put(mapKey, mapValue, {\r\n            expirationTtl: CONFIG.MESSAGE_MAP_TTL_SECONDS\r\n        });\r\n    }\r\n}\r\n", "import { Logger } from '../core/logger.js';\r\n\r\nexport async function safeGetJSON(env, key, defaultValue = null) {\r\n    try {\r\n        const data = await env.TOPIC_MAP.get(key, { type: 'json' });\r\n        if (data === null || data === undefined) {\r\n            return defaultValue;\r\n        }\r\n        if (typeof data !== 'object') {\r\n            Logger.warn('kv_invalid_type', { key, type: typeof data });\r\n            return defaultValue;\r\n        }\r\n        return data;\r\n    } catch (e) {\r\n        Logger.error('kv_parse_failed', e, { key });\r\n        return defaultValue;\r\n    }\r\n}\r\n\r\nexport async function safeGetWithMetadata(env, key, defaultValue = null) {\r\n    try {\r\n        const result = await env.TOPIC_MAP.getWithMetadata(key, { type: 'json' });\r\n        if (!result || !result.value) {\r\n            return { value: defaultValue, metadata: null };\r\n        }\r\n        if (typeof result.value !== 'object') {\r\n            Logger.warn('kv_invalid_type', { key, type: typeof result.value });\r\n            return { value: defaultValue, metadata: result.metadata };\r\n        }\r\n        return { value: result.value, metadata: result.metadata };\r\n    } catch (e) {\r\n        Logger.error('kv_get_with_metadata_failed', e, { key });\r\n        return { value: defaultValue, metadata: null };\r\n    }\r\n}\r\n\r\nexport async function safeGetBulk(env, keys, defaultValue = null) {\r\n    if (!keys || keys.length === 0) return new Map();\r\n\r\n    try {\r\n        const results = await env.TOPIC_MAP.get(keys, { type: 'json' });\r\n        if (!(results instanceof Map)) return new Map();\r\n\r\n        const validated = new Map();\r\n        for (const [key, value] of results) {\r\n            if (value === null) {\r\n                validated.set(key, defaultValue);\r\n            } else if (typeof value === 'object') {\r\n                validated.set(key, value);\r\n            } else {\r\n                Logger.warn('kv_bulk_invalid_type', { key, type: typeof value });\r\n                validated.set(key, defaultValue);\r\n            }\r\n        }\r\n        return validated;\r\n    } catch (e) {\r\n        Logger.error('kv_bulk_get_failed', e, { keyCount: keys.length });\r\n        return new Map();\r\n    }\r\n}\r\n\r\nexport async function getAllKeys(env, prefix = '', limit = null) {\r\n    const allKeys = [];\r\n    let cursor = undefined;\r\n    let count = 0;\r\n\r\n    do {\r\n        const result = await env.TOPIC_MAP.list({ prefix, cursor });\r\n\r\n        for (const key of result.keys) {\r\n            if (limit && count >= limit) break;\r\n            allKeys.push(key);\r\n            count++;\r\n        }\r\n\r\n        if (limit && count >= limit) break;\r\n        cursor = result.list_complete ? undefined : result.cursor;\r\n    } while (cursor);\r\n\r\n    return allKeys;\r\n}\r\n\r\nexport async function putWithMetadata(env, key, value, options = {}) {\r\n    const {\r\n        expirationTtl = null,\r\n        metadata = {}\r\n    } = options;\r\n\r\n    const finalMetadata = {\r\n        updatedAt: Date.now(),\r\n        ...metadata,\r\n        createdAt: metadata.createdAt || Date.now()\r\n    };\r\n\r\n    const putOptions = {\r\n        metadata: finalMetadata\r\n    };\r\n\r\n    if (expirationTtl) putOptions.expirationTtl = expirationTtl;\r\n\r\n    try {\r\n        await env.TOPIC_MAP.put(key, JSON.stringify(value), putOptions);\r\n    } catch (e) {\r\n        Logger.error('kv_put_with_metadata_failed', e, { key });\r\n        throw e;\r\n    }\r\n}\r\n\r\nexport async function deleteBulk(env, keys) {\r\n    if (!keys || keys.length === 0) return 0;\r\n\r\n    try {\r\n        const deletePromises = keys.map(key =>\r\n            env.TOPIC_MAP.delete(key).catch(e => {\r\n                Logger.warn('kv_delete_failed', { key, error: e.message });\r\n            })\r\n        );\r\n\r\n        await Promise.all(deletePromises);\r\n        return keys.length;\r\n    } catch (e) {\r\n        Logger.error('kv_bulk_delete_failed', e, { keyCount: keys.length });\r\n        return 0;\r\n    }\r\n}\r\n\r\nexport async function getWithCache(env, key, cacheTtl = 60, type = 'json') {\r\n    try {\r\n        return await env.TOPIC_MAP.get(key, {\r\n            type,\r\n            cacheTtl: Math.max(30, cacheTtl)\r\n        });\r\n    } catch (e) {\r\n        Logger.error('kv_get_with_cache_failed', e, { key });\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function getValueWithFullMetadata(env, key) {\r\n    try {\r\n        const { value, metadata } = await env.TOPIC_MAP.getWithMetadata(key, { type: 'json' });\r\n\r\n        if (!value) return null;\r\n\r\n        const createdAt = metadata?.createdAt || Date.now();\r\n        const updatedAt = metadata?.updatedAt || createdAt;\r\n        const now = Date.now();\r\n\r\n        return {\r\n            value,\r\n            metadata: metadata || {},\r\n            createdAt,\r\n            updatedAt,\r\n            age: now - createdAt,\r\n            ageSeconds: Math.floor((now - createdAt) / 1000)\r\n        };\r\n    } catch (e) {\r\n        Logger.error('kv_get_full_metadata_failed', e, { key });\r\n        return null;\r\n    }\r\n}\r\n", "export function createWebhookFetchHandler({\r\n    Logger,\r\n    tgCall,\r\n    flushExpiredMediaGroups,\r\n    handleEditedMessage,\r\n    handleCallbackQuery,\r\n    handlePrivateMessage,\r\n    updateThreadStatus,\r\n    handleAdminReply\r\n}) {\r\n    return async function fetch(request, env, ctx) {\r\n        if (!env.TOPIC_MAP) return new Response(\"Error: KV 'TOPIC_MAP' not bound.\");\r\n        if (!env.TG_BOT_DB) return new Response(\"Error: D1 'TG_BOT_DB' not bound.\");\r\n        if (!env.BOT_TOKEN) return new Response('Error: BOT_TOKEN not set.');\r\n        if (!env.SUPERGROUP_ID) return new Response('Error: SUPERGROUP_ID not set.');\r\n\r\n        const normalizedEnv = {\r\n            ...env,\r\n            SUPERGROUP_ID: String(env.SUPERGROUP_ID),\r\n            BOT_TOKEN: String(env.BOT_TOKEN)\r\n        };\r\n\r\n        if (!normalizedEnv.SUPERGROUP_ID.startsWith('-100')) {\r\n            return new Response('Error: SUPERGROUP_ID must start with -100');\r\n        }\r\n\r\n        if (request.method !== 'POST') return new Response('OK');\r\n\r\n        const contentType = request.headers.get('content-type') || '';\r\n        if (!contentType.includes('application/json')) {\r\n            Logger.warn('invalid_content_type', { contentType });\r\n            return new Response('OK');\r\n        }\r\n\r\n        let update;\r\n        try {\r\n            update = await request.json();\r\n            if (!update || typeof update !== 'object') {\r\n                Logger.warn('invalid_json_structure', { update: typeof update });\r\n                return new Response('OK');\r\n            }\r\n        } catch (e) {\r\n            Logger.error('json_parse_failed', e);\r\n            return new Response('OK');\r\n        }\r\n\r\n        if (update.edited_message) {\r\n            await handleEditedMessage(update.edited_message, normalizedEnv, ctx);\r\n            return new Response('OK');\r\n        }\r\n\r\n        if (update.callback_query) {\r\n            await handleCallbackQuery(update.callback_query, normalizedEnv, ctx);\r\n            return new Response('OK');\r\n        }\r\n\r\n        const msg = update.message;\r\n        if (!msg) return new Response('OK');\r\n\r\n        ctx.waitUntil(flushExpiredMediaGroups(normalizedEnv, Date.now()));\r\n\r\n        if (msg.chat && msg.chat.type === 'private') {\r\n            try {\r\n                await handlePrivateMessage(msg, normalizedEnv, ctx);\r\n            } catch (e) {\r\n                const errText = '\u26A0\uFE0F \u7CFB\u7EDF\u7E41\u5FD9\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002';\r\n                await tgCall(normalizedEnv, 'sendMessage', { chat_id: msg.chat.id, text: errText });\r\n                Logger.error('private_message_failed', e, { userId: msg.chat.id });\r\n            }\r\n            return new Response('OK');\r\n        }\r\n\r\n        if (msg.chat && String(msg.chat.id) === normalizedEnv.SUPERGROUP_ID) {\r\n            if (msg.forum_topic_closed && msg.message_thread_id) {\r\n                await updateThreadStatus(msg.message_thread_id, true, normalizedEnv);\r\n                return new Response('OK');\r\n            }\r\n            if (msg.forum_topic_reopened && msg.message_thread_id) {\r\n                await updateThreadStatus(msg.message_thread_id, false, normalizedEnv);\r\n                return new Response('OK');\r\n            }\r\n            const text = (msg.text || '').trim();\r\n            const isCommand = !!text && text.startsWith('/');\r\n            if (msg.message_thread_id || isCommand) {\r\n                await handleAdminReply(msg, normalizedEnv, ctx);\r\n                return new Response('OK');\r\n            }\r\n        }\r\n\r\n        return new Response('OK');\r\n    };\r\n}\r\n", "/**\r\n * Telegram \u53CC\u5411\u673A\u5668\u4EBA\r\n *\r\n * Cloudflare Worker \u811A\u672C\uFF0C\u5B9E\u73B0\u7528\u6237\u79C1\u804A\u6D88\u606F\u8F6C\u53D1\u81F3\u8D85\u7EA7\u7FA4\u7EC4\u8BDD\u9898\u3002\r\n * \u5305\u542B\u4EBA\u673A\u9A8C\u8BC1\u3001\u9650\u6D41\u3001\u7BA1\u7406\u5458\u547D\u4EE4\u3001\u6D88\u606F\u7F16\u8F91\u540C\u6B65\u7B49\u529F\u80FD\u3002\r\n */\r\n\r\nimport { RateLimitDO } from './do/rate-limit-do.js';\r\nimport { CONFIG, LOCAL_QUESTIONS } from './config/constants.js';\r\nimport { Logger } from './core/logger.js';\r\nimport { secureRandomId, secureRandomInt } from './core/random.js';\r\nimport { tgCall } from './adapters/telegram.js';\r\nimport { checkRateLimit } from './services/rate-limit.js';\r\nimport { getFilterText, validateKeywordPattern, matchKeyword } from './services/keywords.js';\r\nimport { isAdminUser } from './services/admin.js';\r\nimport { withMessageThreadId, normalizeTgDescription, isTopicMissingOrDeleted, sendWelcomeCard, probeForumThread } from './services/topic-utils.js';\r\nimport { sendVerificationChallengeImpl, handleCallbackQueryImpl } from './services/verification.js';\r\nimport { handleMediaGroupImpl, flushExpiredMediaGroupsImpl, delaySendImpl } from './services/media-group.js';\r\nimport { handleCleanupCommandImpl } from './services/cleanup.js';\r\nimport { getOrCreateUserTopicRecImpl, resetUserVerificationAndRequireReverifyImpl, createTopicImpl, updateThreadStatusImpl, buildTopicTitleImpl } from './services/topic-lifecycle.js';\r\nimport { handleEditedMessageImpl } from './services/edit-sync.js';\nimport { handleAdminReplyImpl } from './services/admin-reply.js';\nimport { handlePrivateMessageImpl, forwardToTopicImpl } from './services/message-flow.js';\nimport { safeGetJSON, getAllKeys, putWithMetadata, deleteBulk } from './adapters/storage-kv.js';\nimport { hasD1, dbUserGet, dbUserUpdate, dbGetVerifyState, dbSetVerifyState, dbIsBanned, dbSetBanned, dbThreadGetUserId, dbThreadPut, dbThreadDelete, dbMessageMapPut, dbMessageMapGet, dbListUsers, dbKeywordListWithId, dbKeywordAdd, dbKeywordDelete, dbKeywordDeleteById } from './adapters/storage-d1.js';\nimport { createWebhookFetchHandler } from './handlers/webhook.js';\r\n\r\n// ============================================================================\r\n// \u914D\u7F6E\u5E38\u91CF\r\n// ============================================================================\r\n\r\n\r\n// ============================================================================\r\n// \u5185\u5B58\u7F13\u5B58\uFF08\u5B9E\u4F8B\u7EA7\uFF09\r\n// ============================================================================\r\n\r\n// \u8BDD\u9898\u5065\u5EB7\u68C0\u67E5\u7F13\u5B58\uFF0C\u51CF\u5C11\u91CD\u590D\u63A2\u6D4B\u8BF7\u6C42\r\nconst threadHealthCache = new Map();\r\n\r\n// \u5E76\u53D1\u4FDD\u62A4\uFF1A\u907F\u514D\u540C\u4E00\u7528\u6237\u77ED\u65F6\u95F4\u5185\u91CD\u590D\u521B\u5EFA\u8BDD\u9898\r\nconst topicCreateInFlight = new Map();\r\n\r\n\r\n// ============================================================================\r\n// \u672C\u5730\u9898\u5E93\r\n// ============================================================================\r\n\r\n\r\n// ============================================================================\r\n// \u65E5\u5FD7\u7CFB\u7EDF\r\n// ============================================================================\r\n\r\n/**\r\n * \u7ED3\u6784\u5316\u65E5\u5FD7\u7CFB\u7EDF\r\n * \u4F7F\u7528 JSON \u683C\u5F0F\u8F93\u51FA\uFF0C\u4FBF\u4E8E\u65E5\u5FD7\u805A\u5408\u548C\u5206\u6790\r\n */\r\n\r\n// ============================================================================\r\n// \u52A0\u5BC6\u5B89\u5168\u5DE5\u5177\r\n// ============================================================================\r\n\r\n/**\r\n * \u751F\u6210\u52A0\u5BC6\u5B89\u5168\u7684\u968F\u673A\u6574\u6570\r\n */\r\n\r\n/**\r\n * \u751F\u6210\u52A0\u5BC6\u5B89\u5168\u7684\u968F\u673A ID\r\n */\r\n\r\n// ============================================================================\r\n// KV \u5B58\u50A8\u5DE5\u5177\r\n// ============================================================================\r\n\r\n\r\n// ============================================================================\r\n// \u8BDD\u9898\u7BA1\u7406\r\n// ============================================================================\r\n\r\n/**\r\n * \u83B7\u53D6\u6216\u521B\u5EFA\u7528\u6237\u8BDD\u9898\u8BB0\u5F55\r\n * \u4F7F\u7528\u5E76\u53D1\u4FDD\u62A4\u907F\u514D\u91CD\u590D\u521B\u5EFA\r\n */\r\nasync function getOrCreateUserTopicRec(from, key, env, userId) {\r\n    return getOrCreateUserTopicRecImpl({\r\n        from,\r\n        key,\r\n        env,\r\n        userId,\r\n        hasD1,\r\n        dbUserGet,\r\n        safeGetJSON,\r\n        createTopic,\r\n        topicCreateInFlight\r\n    });\r\n}\r\n\r\n/**\r\n * \u91CD\u7F6E\u7528\u6237\u9A8C\u8BC1\u5E76\u8981\u6C42\u91CD\u65B0\u9A8C\u8BC1\r\n */\r\nasync function resetUserVerificationAndRequireReverify(env, { userId, userKey, oldThreadId, pendingMsgId, reason, userFrom = null }) {\r\n    return resetUserVerificationAndRequireReverifyImpl({\r\n        env,\r\n        userId,\r\n        userKey,\r\n        oldThreadId,\r\n        pendingMsgId,\r\n        reason,\r\n        hasD1,\r\n        dbUserUpdate,\r\n        dbThreadDelete,\r\n        CONFIG,\r\n        threadHealthCache,\r\n        Logger,\r\n        sendVerificationChallenge\r\n    });\r\n}\r\n\r\n// ============================================================================\r\n// \u7BA1\u7406\u5458\u7BA1\u7406\r\n// ============================================================================\r\n\r\n/**\r\n * \u89E3\u6790\u7BA1\u7406\u5458 ID \u767D\u540D\u5355\r\n */\r\n// ============================================================================\r\n// \u6D88\u606F\u961F\u5217\u7CFB\u7EDF\r\n// ============================================================================\r\n\r\n// ============================================================================\n// \u5DE5\u5177\u51FD\u6570\n// ============================================================================\n\r\n/**\r\n * Fisher-Yates \u6D17\u724C\u7B97\u6CD5\r\n */\r\nfunction shuffleArray(arr) {\r\n    const array = [...arr];\r\n    for (let i = array.length - 1; i > 0; i--) {\r\n        const j = secureRandomInt(0, i + 1);\r\n        [array[i], array[j]] = [array[j], array[i]];\r\n    }\r\n    return array;\r\n}\r\n\r\n// ============================================================================\r\n// Worker \u5165\u53E3\u70B9\r\n// ============================================================================\r\n\r\nexport { RateLimitDO };\r\n\r\nconst fetchHandler = createWebhookFetchHandler({\r\n    Logger,\r\n    tgCall,\r\n    flushExpiredMediaGroups,\r\n    handleEditedMessage,\r\n    handleCallbackQuery,\r\n    handlePrivateMessage,\r\n    updateThreadStatus,\r\n    handleAdminReply\r\n});\r\n\r\nexport default {\r\n    fetch: fetchHandler\r\n};\r\n\r\n// ============================================================================\r\n// \u6838\u5FC3\u4E1A\u52A1\u903B\u8F91\r\n// ============================================================================\r\n\r\n/**\r\n * \u5904\u7406\u79C1\u804A\u6D88\u606F\r\n */\r\nasync function handlePrivateMessage(msg, env, ctx) {\r\n    return handlePrivateMessageImpl(msg, env, ctx, {\r\n        forwardToTopic\r\n    });\r\n}\r\n\r\n/**\r\n * \u8F6C\u53D1\u6D88\u606F\u5230\u8BDD\u9898\r\n */\r\nasync function forwardToTopic(msg, env, ctx) {\r\n    return forwardToTopicImpl(msg, env, ctx, {\r\n        checkRateLimit,\r\n        CONFIG,\r\n        tgCall,\r\n        hasD1,\r\n        dbIsBanned,\r\n        dbGetVerifyState,\r\n        sendVerificationChallenge,\r\n        getFilterText,\r\n        matchKeyword,\r\n        Logger,\r\n        dbUserGet,\r\n        safeGetJSON,\r\n        getOrCreateUserTopicRec,\r\n        sendWelcomeCard,\r\n        dbThreadGetUserId,\r\n        dbThreadPut,\r\n        threadHealthCache,\r\n        probeForumThread,\r\n        resetUserVerificationAndRequireReverify,\r\n        handleMediaGroup,\r\n        normalizeTgDescription,\r\n        isTopicMissingOrDeleted,\r\n        dbMessageMapPut\r\n    });\r\n}\r\n\r\n/**\r\n * \u5904\u7406\u7BA1\u7406\u5458\u56DE\u590D\r\n */\r\nasync function handleAdminReply(msg, env, ctx) {\r\n    return handleAdminReplyImpl(msg, env, ctx, {\r\n        isAdminUser,\r\n        hasD1,\r\n        dbKeywordListWithId,\r\n        tgCall,\r\n        dbSetBanned,\r\n        dbThreadGetUserId,\r\n        dbThreadPut,\r\n        getAllKeys,\r\n        safeGetJSON,\r\n        dbKeywordAdd,\r\n        dbKeywordDelete,\r\n        dbKeywordDeleteById,\r\n        validateKeywordPattern,\r\n        CONFIG,\r\n        dbUserUpdate,\r\n        dbSetVerifyState,\r\n        dbUserGet,\r\n        dbGetVerifyState,\r\n        dbIsBanned,\r\n        handleMediaGroup,\r\n        dbMessageMapPut,\r\n        handleCleanupCommand\r\n    });\r\n}\r\n\r\n// ============================================================================\r\n// \u9A8C\u8BC1\u6A21\u5757\r\n// ============================================================================\r\n\r\n/**\r\n * \u53D1\u9001\u4EBA\u673A\u9A8C\u8BC1\u6311\u6218\r\n */\r\nasync function sendVerificationChallenge(userId, env, pendingMsgId) {\r\n    return sendVerificationChallengeImpl({\r\n        userId,\r\n        env,\r\n        pendingMsgId,\r\n        safeGetJSON,\r\n        checkRateLimit,\r\n        tgCall,\r\n        Logger,\r\n        CONFIG,\r\n        LOCAL_QUESTIONS,\r\n        secureRandomInt,\r\n        shuffleArray,\r\n        secureRandomId\r\n    });\r\n}\r\n\r\n/**\r\n * \u5904\u7406\u9A8C\u8BC1\u6309\u94AE\u70B9\u51FB\r\n */\r\nasync function handleCallbackQuery(query, env, ctx) {\r\n    return handleCallbackQueryImpl({\r\n        query,\r\n        env,\r\n        ctx,\r\n        tgCall,\r\n        Logger,\r\n        hasD1,\r\n        dbSetVerifyState,\r\n        CONFIG,\r\n        forwardToTopic\r\n    });\r\n}\r\n\r\n// ============================================================================\r\n// \u7BA1\u7406\u547D\u4EE4\r\n// ============================================================================\r\n\r\n/**\r\n * \u5904\u7406 /cleanup \u547D\u4EE4\r\n * \u6279\u91CF\u6E05\u7406\u5DF2\u5220\u9664\u8BDD\u9898\u7684\u7528\u6237\u8BB0\u5F55\r\n */\r\nasync function handleCleanupCommand(threadId, env) {\r\n    return handleCleanupCommandImpl({\r\n        threadId,\r\n        env,\r\n        CONFIG,\r\n        hasD1,\r\n        dbListUsers,\r\n        probeForumThread,\r\n        resetUserVerificationAndRequireReverify,\r\n        Logger,\r\n        safeGetJSON,\r\n        deleteBulk,\r\n        tgCall,\r\n        withMessageThreadId\r\n    });\r\n}\r\n\r\n// ============================================================================\r\n// \u8BDD\u9898\u521B\u5EFA\u548C\u7BA1\u7406\r\n// ============================================================================\r\n\r\n/**\r\n * \u521B\u5EFA\u65B0\u8BBA\u575B\u8BDD\u9898\r\n */\r\nasync function createTopic(from, key, env, userId) {\r\n    return createTopicImpl({\r\n        from,\r\n        key,\r\n        env,\r\n        userId,\r\n        CONFIG,\r\n        tgCall,\r\n        hasD1,\r\n        dbUserUpdate,\r\n        dbThreadPut,\r\n        putWithMetadata,\r\n        buildTopicTitle\r\n    });\r\n}\r\n\r\n/**\r\n * \u66F4\u65B0\u8BDD\u9898\u72B6\u6001\uFF08\u5173\u95ED/\u6253\u5F00\uFF09\r\n */\r\nasync function updateThreadStatus(threadId, isClosed, env) {\r\n    return updateThreadStatusImpl({\r\n        threadId,\r\n        isClosed,\r\n        env,\r\n        hasD1,\r\n        dbThreadGetUserId,\r\n        dbUserGet,\r\n        dbUserUpdate,\r\n        dbThreadDelete,\r\n        safeGetJSON,\r\n        getAllKeys,\r\n        Logger\r\n    });\r\n}\r\n\r\n/**\r\n * \u6784\u5EFA\u8BDD\u9898\u6807\u9898\r\n */\r\nfunction buildTopicTitle(from) {\r\n    return buildTopicTitleImpl(from, CONFIG);\r\n}\r\n\r\n// ============================================================================\r\n// Telegram API\r\n// ============================================================================\r\n\r\n// ============================================================================\r\n// \u5A92\u4F53\u7EC4\u5904\u7406\r\n// ============================================================================\r\n\r\n/**\r\n * \u5904\u7406\u5A92\u4F53\u7EC4\u6D88\u606F\r\n */\r\nasync function handleMediaGroup(msg, env, ctx, { direction, targetChat, threadId }) {\r\n    return handleMediaGroupImpl({\r\n        msg,\r\n        env,\r\n        ctx,\r\n        direction,\r\n        targetChat,\r\n        threadId,\r\n        tgCall,\r\n        withMessageThreadId,\r\n        safeGetJSON,\r\n        delaySend,\r\n        CONFIG\r\n    });\r\n}\r\n\r\n/**\r\n * \u6E05\u7406\u8FC7\u671F\u7684\u5A92\u4F53\u7EC4\r\n */\r\nasync function flushExpiredMediaGroups(env, now) {\r\n    return flushExpiredMediaGroupsImpl({ env, now, getAllKeys, safeGetJSON, Logger });\r\n}\r\n\r\n/**\r\n * \u5EF6\u8FDF\u53D1\u9001\u5A92\u4F53\u7EC4\r\n */\r\nasync function delaySend(env, key, ts) {\r\n    return delaySendImpl({\r\n        env,\r\n        key,\r\n        ts,\r\n        CONFIG,\r\n        safeGetJSON,\r\n        Logger,\r\n        tgCall,\r\n        withMessageThreadId\r\n    });\r\n}\r\n\r\n// ============================================================================\n// \u6D88\u606F\u7F16\u8F91\u540C\u6B65\n// ============================================================================\n\r\n/**\r\n * \u5904\u7406\u6D88\u606F\u7F16\u8F91\r\n * \u652F\u6301\u7528\u6237\u7AEF\u548C\u7BA1\u7406\u5458\u7AEF\u7684\u7F16\u8F91\u540C\u6B65\r\n */\r\nasync function handleEditedMessage(msg, env, ctx) {\r\n    return handleEditedMessageImpl({\r\n        msg,\r\n        env,\r\n        hasD1,\r\n        dbMessageMapGet,\r\n        safeGetJSON,\r\n        dbUserGet,\r\n        tgCall,\r\n        Logger\r\n    });\r\n}\r\n", "import worker, { RateLimitDO } from './src/app.js';\r\n\r\nexport { RateLimitDO };\r\nexport default worker;\r\n"],
  "mappings": "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",
  "names": ["safeGetJSON", "checkRateLimit", "tgCall", "Logger", "CONFIG", "LOCAL_QUESTIONS", "secureRandomInt", "shuffleArray", "secureRandomId", "state", "hasD1", "dbSetVerifyState", "forwardToTopic", "tgCall", "withMessageThreadId", "safeGetJSON", "delaySend", "CONFIG", "getAllKeys", "Logger", "CONFIG", "hasD1", "dbListUsers", "probeForumThread", "resetUserVerificationAndRequireReverify", "Logger", "safeGetJSON", "deleteBulk", "tgCall", "withMessageThreadId", "result", "hasD1", "dbUserGet", "safeGetJSON", "createTopic", "topicCreateInFlight", "dbUserUpdate", "dbThreadDelete", "CONFIG", "threadHealthCache", "Logger", "sendVerificationChallenge", "tgCall", "dbThreadPut", "putWithMetadata", "buildTopicTitle", "dbThreadGetUserId", "getAllKeys", "mappedUser", "hasD1", "dbMessageMapGet", "safeGetJSON", "dbUserGet", "tgCall", "Logger", "isAdminUser", "hasD1", "dbKeywordListWithId", "tgCall", "dbSetBanned", "dbThreadGetUserId", "dbThreadPut", "getAllKeys", "safeGetJSON", "dbKeywordAdd", "dbKeywordDelete", "dbKeywordDeleteById", "validateKeywordPattern", "CONFIG", "dbUserUpdate", "dbSetVerifyState", "dbUserGet", "dbGetVerifyState", "dbIsBanned", "handleMediaGroup", "dbMessageMapPut", "handleCleanupCommand", "parts", "changes", "forwardToTopic", "checkRateLimit", "CONFIG", "tgCall", "hasD1", "dbIsBanned", "dbGetVerifyState", "sendVerificationChallenge", "getFilterText", "matchKeyword", "Logger", "dbUserGet", "safeGetJSON", "getOrCreateUserTopicRec", "sendWelcomeCard", "dbThreadGetUserId", "dbThreadPut", "threadHealthCache", "probeForumThread", "resetUserVerificationAndRequireReverify", "handleMediaGroup", "normalizeTgDescription", "isTopicMissingOrDeleted", "dbMessageMapPut", "Logger", "tgCall", "flushExpiredMediaGroups", "handleEditedMessage", "handleCallbackQuery", "handlePrivateMessage", "updateThreadStatus", "handleAdminReply", "fetch"]
}
